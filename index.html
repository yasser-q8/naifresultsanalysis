<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شركة نايف للأغذية - نظام التحليل المالي المتكامل</title>
    
    <!-- الخطوط والمكتبات -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- شعار الشركة -->
    <link rel="icon" href="https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg" type="image/jpeg">
    
    <style>
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #50C878;
            --accent-color: #FF6B6B;
            --dark-color: #2C3E50;
            --light-color: #F5F7FA;
            --text-color: #333333;
            --border-color: #E0E0E0;
            --card-bg: #FFFFFF;
            --sidebar-bg: #2C3E50;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --purple-color: #9B59B6;
            --orange-color: #F39C12;
            --teal-color: #1ABC9C;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--light-color);
            color: var(--text-color);
            direction: rtl;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #357ABD);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1750px;
            margin: 0 auto;
        }

        .logo-placeholder {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-placeholder .logo-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-image: url('https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg');
            background-size: cover;
            background-position: center;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .logo-text h1 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .logo-text p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .date-display {
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Arial', sans-serif;
        }

        .date-display i {
            font-size: 1.1rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #40A068;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(80, 200, 120, 0.3);
        }

        .btn-secondary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #3A80D2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }

        .container {
            display: flex;
            min-height: calc(100vh - 80px);
            max-width: 1750px;
            margin: 0 auto;
            gap: 20px;
        }

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: white;
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-radius: 0 0 0 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 80px;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 10px;
            margin-bottom: 10px;
        }

        .sidebar-header h3 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255,255,255,0.9);
        }

        .sidebar-menu {
            list-style: none;
            flex: 1;
        }

        .sidebar-menu li {
            padding: 15px 20px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .sidebar-menu li:before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--primary-color);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .sidebar-menu li:hover {
            background-color: rgba(255,255,255,0.1);
            transform: translateX(-5px);
        }

        .sidebar-menu li:hover:before {
            transform: translateX(0);
        }

        .sidebar-menu li.active {
            background-color: rgba(74, 144, 226, 0.2);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .sidebar-menu li.active:before {
            transform: translateX(0);
        }

        .sidebar-menu li i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
            color: rgba(255,255,255,0.8);
        }

        .sidebar-menu li span {
            flex: 1;
        }

        .sidebar-menu .menu-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .main-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background-color: var(--light-color);
            border-radius: 20px 0 0 20px;
            margin: 10px 0 10px 0;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .dashboard-header h1 {
            font-size: 1.8rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .dashboard-header h1 i {
            color: var(--primary-color);
            background: rgba(74, 144, 226, 0.1);
            padding: 12px;
            border-radius: 12px;
        }

        .dashboard-actions {
            display: flex;
            gap: 10px;
            position: relative;
            z-index: 1;
        }

        .company-summary {
            background: linear-gradient(135deg, var(--primary-color), #3A80D2);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.3);
        }

        .company-summary h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .summary-item {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .summary-item:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .summary-item i {
            font-size: 2rem;
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 12px;
        }

        .summary-item .value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            font-family: 'Arial', sans-serif;
        }

        .summary-item .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-card:before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            flex-shrink: 0;
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            display: block;
            margin-bottom: 5px;
            font-family: 'Arial', sans-serif;
            direction: ltr;
            text-align: left;
        }

        .stat-label {
            font-size: 1rem;
            color: #666;
            display: block;
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 0.9rem;
            padding: 3px 10px;
            border-radius: 12px;
            display: inline-block;
            font-weight: 600;
        }

        .stat-change.positive {
            background-color: rgba(80, 200, 120, 0.15);
            color: var(--secondary-color);
        }

        .stat-change.negative {
            background-color: rgba(255, 107, 107, 0.15);
            color: var(--accent-color);
        }

        .chart-container {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-header h2 {
            font-size: 1.4rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-header h2 i {
            color: var(--primary-color);
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .interactive-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-card-header h3 {
            font-size: 1.3rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-card-header h3 i {
            color: var(--primary-color);
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
            
            .interactive-charts {
                grid-template-columns: 1fr;
            }
        }

        .table-container {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h2 {
            font-size: 1.4rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-header h2 i {
            color: var(--primary-color);
        }

        .table-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            font-family: 'Arial', sans-serif;
        }

        .data-table th {
            background-color: var(--light-color);
            color: var(--dark-color);
            font-weight: 700;
            padding: 15px;
            text-align: right;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: right;
            direction: ltr;
            font-family: 'Arial', sans-serif;
        }

        .data-table tr:hover {
            background-color: rgba(74, 144, 226, 0.05);
        }

        .data-table tr.total-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .data-table .positive {
            color: var(--secondary-color);
            font-weight: 600;
        }

        .data-table .negative {
            color: var(--accent-color);
            font-weight: 600;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background-color: rgba(40, 167, 69, 0.15);
            color: var(--success-color);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .badge-primary {
            background-color: rgba(74, 144, 226, 0.15);
            color: var(--primary-color);
            border: 1px solid rgba(74, 144, 226, 0.3);
        }

        .badge-warning {
            background-color: rgba(255, 193, 7, 0.15);
            color: var(--warning-color);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .badge-danger {
            background-color: rgba(220, 53, 69, 0.15);
            color: var(--danger-color);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .badge-secondary {
            background-color: rgba(108, 117, 125, 0.15);
            color: #6c757d;
            border: 1px solid rgba(108, 117, 125, 0.3);
        }

        .restaurant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .restaurant-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .restaurant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .restaurant-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .restaurant-card-header h3 {
            color: var(--dark-color);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .restaurant-id {
            background: var(--light-color);
            color: #666;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .restaurant-info {
            margin: 15px 0;
        }

        .restaurant-info p {
            margin: 8px 0;
            color: #666;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .restaurant-info p strong {
            color: var(--dark-color);
            min-width: 100px;
        }

        .restaurant-stats {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .restaurant-stats span {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #666;
        }

        .restaurant-stats i {
            color: var(--primary-color);
        }

        .restaurant-performance {
            margin: 15px 0;
        }

        .performance-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .performance-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .performance-text {
            font-size: 0.85rem;
            color: #666;
            display: block;
            text-align: center;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .btn-icon {
            padding: 8px 12px;
            background: #f8f9fa;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            color: var(--dark-color);
            font-family: 'Cairo', sans-serif;
            flex: 1;
            justify-content: center;
        }

        .btn-icon:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .btn-icon i {
            font-size: 0.9rem;
        }

        .manager-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .manager-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .manager-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .manager-card-header h3 {
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .manager-type {
            background: var(--light-color);
            color: #666;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .manager-type.area-manager {
            background: rgba(74, 144, 226, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(74, 144, 226, 0.3);
        }

        .manager-type.ops-manager {
            background: rgba(80, 200, 120, 0.1);
            color: var(--secondary-color);
            border: 1px solid rgba(80, 200, 120, 0.3);
        }

        .manager-info {
            margin: 15px 0;
        }

        .manager-info p {
            margin: 8px 0;
            color: #666;
            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .manager-info p strong {
            color: var(--dark-color);
            min-width: 100px;
        }

        .manager-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            display: block;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            display: block;
            font-family: 'Arial', sans-serif;
        }

        .filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 250px;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--dark-color);
            min-width: 100px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            flex: 1;
            background: white;
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .form-select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            background: white;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .planning-form {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .implementation-plan {
            margin-top: 30px;
        }

        .timeline {
            position: relative;
            padding-right: 30px;
        }

        .timeline:before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 2px;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding-right: 30px;
        }

        .timeline-item:before {
            content: '';
            position: absolute;
            right: -6px;
            top: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 3px solid white;
            box-shadow: 0 0 0 3px var(--primary-color);
        }

        .timeline-date {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .timeline-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-right: 3px solid var(--primary-color);
        }

        .timeline-content h5 {
            color: var(--dark-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .timeline-content ul {
            list-style: none;
            padding-right: 0;
        }

        .timeline-content li {
            padding: 5px 0;
            color: #666;
            position: relative;
            padding-right: 20px;
        }

        .timeline-content li:before {
            content: '✓';
            position: absolute;
            right: 0;
            color: var(--secondary-color);
            font-weight: bold;
        }

        .advanced-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .analysis-card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .analysis-card h4 {
            font-size: 1.2rem;
            color: var(--dark-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 15px 0;
        }

        .analysis-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .analysis-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: #666;
        }

        .analysis-detail .value {
            font-weight: 600;
            color: var(--dark-color);
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .export-option {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .export-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .export-option i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .export-option h3 {
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .export-option p {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            height: 100%;
            justify-content: center;
        }

        .loading i {
            font-size: 3rem;
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                flex-direction: row;
                justify-content: space-between;
                padding: 15px;
                height: auto;
                position: static;
                border-radius: 0;
                flex-wrap: wrap;
            }
            
            .sidebar-menu {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                width: 100%;
                order: 2;
                margin-top: 15px;
            }
            
            .sidebar-menu li {
                margin-bottom: 0;
                padding: 10px 15px;
                flex: 1;
                min-width: 150px;
                text-align: center;
                justify-content: center;
            }
            
            .quick-stats {
                display: none;
            }
            
            .main-content {
                margin: 0;
                border-radius: 0;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0.8rem 1rem;
            }
            
            .nav-container {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .logo-text h1 {
                font-size: 1.2rem;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .charts-row {
                grid-template-columns: 1fr;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 20px;
            }
            
            .dashboard-header h1 {
                font-size: 1.5rem;
                justify-content: center;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: flex-start;
                min-width: 100%;
            }
            
            .filter-group label {
                margin-bottom: 5px;
            }
            
            .restaurant-grid {
                grid-template-columns: 1fr;
            }
            
            .manager-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .table-controls {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 480px) {
            .restaurant-stats {
                grid-template-columns: 1fr;
            }
            
            .manager-stats {
                grid-template-columns: 1fr;
            }
            
            .card-actions {
                flex-direction: column;
            }
            
            .btn-icon {
                width: 100%;
            }
            
            .export-options {
                grid-template-columns: 1fr;
            }
            
            .analysis-card {
                padding: 20px;
            }
            
            .analysis-value {
                font-size: 1.8rem;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4A90E2;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 300px;
            max-width: 400px;
            font-family: 'Cairo', sans-serif;
        }
        
        .notification.success {
            background: #50C878;
        }
        
        .notification.error {
            background: #FF6B6B;
        }
        
        .notification.info {
            background: #4A90E2;
        }
        
        .notification i {
            font-size: 1.2rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: var(--accent-color);
        }

        .restaurant-details {
            max-width: 800px;
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .details-header h3 {
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .details-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .summary-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .details-section {
            margin: 25px 0;
        }

        .details-section h4 {
            color: var(--dark-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .monthly-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .month-detail {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
        }

        .month-detail h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .detail-grid {
            display: grid;
            gap: 8px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .details-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .plan-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .plan-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .plan-item:last-child {
            border-bottom: none;
        }

        .plan-label {
            font-weight: 600;
            color: var(--dark-color);
        }

        .plan-value {
            font-weight: 700;
            font-family: 'Arial', sans-serif;
        }

        .plan-value.positive {
            color: var(--secondary-color);
        }

        .action-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Cairo', sans-serif;
        }

        .comparison-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .comparison-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .comparison-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric {
            text-align: center;
        }

        .metric .value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Arial', sans-serif;
        }

        .metric .label {
            font-size: 0.9rem;
            color: #666;
        }

        .planning-table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow-x: auto;
        }

        .planning-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .planning-table th {
            background: var(--light-color);
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
            font-weight: 600;
        }

        .planning-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
            direction: ltr;
        }

        .planning-table .month-header {
            background: var(--primary-color);
            color: white;
        }

        .planning-table .total-header {
            background: var(--secondary-color);
            color: white;
        }

        .planning-table input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .comparison-table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .comparison-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* تنسيقات جديدة لشاشة التخطيط */
        .planning-percentages-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .percentage-controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .percentage-preview {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .percentage-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .percentage-group:last-child {
            border-bottom: none;
        }

        .percentage-group h4 {
            color: var(--dark-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .percentage-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .percentage-item:last-child {
            border-bottom: none;
        }

        .percentage-item label {
            font-weight: 500;
            color: var(--dark-color);
            flex: 1;
        }

        .percentage-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 200px;
        }

        .percentage-input-group input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            font-family: 'Arial', sans-serif;
        }

        .percentage-input-group span {
            color: #666;
            font-weight: 500;
            width: 30px;
        }

        .account-group-header {
            background: var(--light-color);
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0 10px 0;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .preview-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            color: #666;
        }

        .preview-item .value {
            font-weight: 600;
            color: var(--dark-color);
        }

        .preview-calculation {
            background: #f0f7ff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: var(--primary-color);
            border-right: 3px solid var(--primary-color);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <div class="logo-placeholder">
                    <div class="logo-image"></div>
                    <div class="logo-text">
                        <h1>شركة نايف للأغذية</h1>
                        <p>نظام التحليل المالي المتكامل</p>
                    </div>
                </div>
            </div>
            
            <div class="nav-controls">
                <div class="date-display">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="current-date">--/--/2025</span>
                </div>
                <button class="btn btn-secondary" id="download-template-btn">
                    <i class="fas fa-download"></i> تحميل نموذج
                </button>
                <button class="btn btn-primary" id="load-excel-btn">
                    <i class="fas fa-upload"></i> تحميل ملف Excel
                </button>
                <input type="file" id="excel-input" accept=".xlsx,.xls" style="display: none;">
            </div>
        </div>
    </nav>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-bars"></i> القائمة الرئيسية</h3>
            </div>
            
            <ul class="sidebar-menu">
                <li class="active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>لوحة التحكم</span>
                    <span class="menu-count">0</span>
                </li>
                <li data-page="monthly-report">
                    <i class="fas fa-calendar-alt"></i>
                    <span>التقرير الشهري</span>
                    <span class="menu-count">12</span>
                </li>
                <li data-page="restaurants">
                    <i class="fas fa-store"></i>
                    <span>المطاعم</span>
                    <span class="menu-count">0</span>
                </li>
                <li data-page="managers">
                    <i class="fas fa-user-tie"></i>
                    <span>المديرون</span>
                    <span class="menu-count">0</span>
                </li>
                <li data-page="cost-analysis">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>تحليل التكاليف</span>
                </li>
                <li data-page="profit-analysis">
                    <i class="fas fa-chart-line"></i>
                    <span>تحليل الربحية</span>
                </li>
                <li data-page="comparison">
                    <i class="fas fa-chart-bar"></i>
                    <span>المقارنة</span>
                </li>
                <li data-page="planning">
                    <i class="fas fa-chart-pie"></i>
                    <span>خطة 2026</span>
                </li>
                <li data-page="export">
                    <i class="fas fa-download"></i>
                    <span>التصدير</span>
                </li>
            </ul>
            
            <div class="quick-stats">
                <h3><i class="fas fa-chart-simple"></i> إحصائيات سريعة</h3>
                <div class="stats-grid">
                    <div class="stat-card mini">
                        <div class="stat-icon" style="background: #4A90E2;">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="rest-count">0</span>
                            <span class="stat-label">مطعم</span>
                        </div>
                    </div>
                    <div class="stat-card mini">
                        <div class="stat-icon" style="background: #50C878;">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="total-sales">0</span>
                            <span class="stat-label">المبيعات</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div id="content-area">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>جار تحميل النظام...</p>
                </div>
            </div>
        </main>
    </div>

    <div id="details-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn">&times;</button>
            <div class="modal-body"></div>
        </div>
    </div>

    <div id="comparison-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn">&times;</button>
            <div class="modal-body"></div>
        </div>
    </div>

    <script>
        // Excel Parser - تم التعديل حسب المطلوب
        class ExcelParser {
            constructor() {
                // Fixed column mapping with exact names from Excel
                this.columnMapping = {
                    'المبيعات': 'sales',
                    'اجمالي تكلفة المواد المباعة': 'totalMaterialCost',
                    'تكلفة - المواد الغذائية - المخازن': 'foodCost',
                    'تكلفة - اللحوم والمقبلات': 'meatCost',
                    'تكلفة - المرطبات': 'drinksCost',
                    'تكلفة - التعبئة والتغليف': 'packagingCost',
                    'تكلفة - الخبز': 'breadCost',
                    'تكلفة - البهارات والتوابل': 'spicesCost',
                    'تكلفة - الفحم': 'coalCost',
                    'تكلفة - الخضار': 'vegetablesCost',
                    'تكلفة - الغاز': 'gasCost',
                    'فرق الجرد بين بضاعة أول المدة و آخر المدة': 'inventoryDifference',
                    'مجمل الربح قبل تنزيل مصاريف التشغيل': 'grossProfit',
                    'مصاريف رواتب واجور': 'salariesCost',
                    'مصاريف أعمال أضافية': 'extraWorkCost',
                    'مصاريف توالف المواد': 'wasteCost',
                    'مصاريف صيانة': 'maintenanceCost',
                    'مصاريف نظافة': 'cleaningCost',
                    'مصاريف لوازم العمال': 'workersSuppliesCost',
                    'مصاريف لوازم المطاعم': 'restaurantSuppliesCost',
                    'مصاريف قرطاسية ومطبوعات': 'stationeryCost',
                    'مصاريف وجبات عاملين': 'workersMealsCost',
                    'باقي مصاريف التشغيل': 'otherOperatingCost',
                    'مجموع مصاريف التشغيل': 'totalOperatingCost',
                    'الربح قبل تنزيل المصاريف العمومية': 'profitBeforeGeneral',
                    'المصاريف العمومية': 'generalExpenses',
                    'صافى الربح': 'netProfit'
                };
                
                // تعريف بنود التكلفة الفرعية (تكون جزء من اجمالي تكلفة المواد)
                this.materialCostAccounts = [
                    'تكلفة - المواد الغذائية - المخازن',
                    'تكلفة - اللحوم والمقبلات',
                    'تكلفة - المرطبات',
                    'تكلفة - التعبئة والتغليف',
                    'تكلفة - الخبز',
                    'تكلفة - البهارات والتوابل',
                    'تكلفة - الفحم',
                    'تكلفة - الخضار',
                    'تكلفة - الغاز'
                ];
                
                // تعريف مصاريف التشغيل
                this.operatingCostAccounts = [
                    'مصاريف رواتب واجور',
                    'مصاريف أعمال أضافية',
                    'مصاريف توالف المواد',
                    'مصاريف صيانة',
                    'مصاريف نظافة',
                    'مصاريف لوازم العمال',
                    'مصاريف لوازم المطاعم',
                    'مصاريف قرطاسية ومطبوعات',
                    'مصاريف وجبات عاملين',
                    'باقي مصاريف التشغيل',
                    'مجموع مصاريف التشغيل'
                ];
                
                // تعريف المصاريف العمومية
                this.generalExpenseAccounts = [
                    'المصاريف العمومية'
                ];
                
                // تعريف حسابات الربح
                this.profitAccounts = [
                    'مجمل الربح قبل تنزيل مصاريف التشغيل',
                    'الربح قبل تنزيل المصاريف العمومية',
                    'صافى الربح'
                ];
            }

            async parseExcel(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            
                            const excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            const restaurants = this.parseRestaurantData(excelData);
                            
                            resolve(restaurants);
                        } catch (error) {
                            reject(new Error(`خطأ في تحليل الملف: ${error.message}`));
                        }
                    };
                    
                    reader.onerror = () => reject(new Error('خطأ في قراءة الملف'));
                    reader.readAsArrayBuffer(file);
                });
            }

            parseRestaurantData(excelData) {
                const restaurants = [];
                const numRows = excelData.length;
                const numCols = excelData[0]?.length || 0;
                
                console.log(`Excel dimensions: ${numRows} rows x ${numCols} columns`);
                
                // كل مطعم يأخذ 12 شهر (12 عمود)
                // البحث عن بداية ونهاية المطاعم
                let currentCol = 1; // البدء من العمود B (العنوان في العمود A)
                
                while (currentCol < numCols) {
                    try {
                        // البحث عن اسم المطعم في الصف الثالث
                        const restaurantName = excelData[2]?.[currentCol]?.toString()?.trim();
                        
                        if (!restaurantName || restaurantName === '' || restaurantName === 'غير محدد') {
                            currentCol += 12; // الانتقال إلى المجموعة التالية (12 شهر)
                            continue;
                        }
                        
                        // الحصول على معلومات المديرين
                        const operationsManager = excelData[0]?.[currentCol]?.toString()?.trim() || 'غير محدد';
                        const areaManager = excelData[1]?.[currentCol]?.toString()?.trim() || 'غير محدد';
                        
                        // تحليل البيانات الشهرية
                        const monthlyData = {};
                        const months = ['يناير 2025', 'فبراير 2025', 'مارس 2025', 'أبريل 2025', 
                                      'مايو 2025', 'يونيو 2025', 'يوليو 2025', 'أغسطس 2025', 
                                      'سبتمبر 2025', 'أكتوبر 2025', 'نوفمبر 2025', 'ديسمبر 2025'];
                        
                        for (let monthIndex = 0; monthIndex < 12; monthIndex++) {
                            const monthCol = currentCol + monthIndex;
                            if (monthCol >= numCols) break;
                            
                            const monthName = months[monthIndex];
                            monthlyData[monthName] = this.parseMonthData(excelData, monthCol);
                        }
                        
                        // حساب الإجمالي السنوي من البيانات الشهرية
                        const annualData = this.calculateAnnualData(monthlyData);
                        
                        // حساب إجماليات المطعم
                        const totals = this.calculateRestaurantTotals(monthlyData);
                        
                        // إنشاء كائن المطعم
                        const restaurant = {
                            id: restaurants.length + 1,
                            name: restaurantName,
                            areaManager: areaManager,
                            operationsManager: operationsManager,
                            monthlyData: monthlyData,
                            annualData: annualData,
                            totals: totals
                        };
                        
                        restaurants.push(restaurant);
                        console.log(`تم تحليل مطعم: ${restaurantName} (${restaurant.id})`);
                        
                        currentCol += 12; // الانتقال إلى المطعم التالي
                    } catch (error) {
                        console.error(`خطأ في تحليل مطعم عند العمود ${currentCol}:`, error);
                        currentCol += 12; // الانتقال إلى المجموعة التالية
                        continue;
                    }
                }
                
                console.log(`تم تحليل ${restaurants.length} مطعم بنجاح`);
                return restaurants;
            }

            parseMonthData(excelData, colIndex) {
                const monthData = {
                    sales: 0,
                    totalMaterialCost: 0,
                    foodCost: 0,
                    meatCost: 0,
                    drinksCost: 0,
                    packagingCost: 0,
                    breadCost: 0,
                    spicesCost: 0,
                    coalCost: 0,
                    vegetablesCost: 0,
                    gasCost: 0,
                    inventoryDifference: 0,
                    grossProfit: 0,
                    salariesCost: 0,
                    extraWorkCost: 0,
                    wasteCost: 0,
                    maintenanceCost: 0,
                    cleaningCost: 0,
                    workersSuppliesCost: 0,
                    restaurantSuppliesCost: 0,
                    stationeryCost: 0,
                    workersMealsCost: 0,
                    otherOperatingCost: 0,
                    totalOperatingCost: 0,
                    profitBeforeGeneral: 0,
                    generalExpenses: 0,
                    netProfit: 0,
                    // الحقول المحسوبة
                    totalCosts: 0,
                    profitMargin: 0
                };
                
                // تحديد صفوف الحسابات
                const accountRows = {
                    'المبيعات': 4,
                    'اجمالي تكلفة المواد المباعة': 5,
                    'تكلفة - المواد الغذائية - المخازن': 6,
                    'تكلفة - اللحوم والمقبلات': 7,
                    'تكلفة - المرطبات': 8,
                    'تكلفة - التعبئة والتغليف': 9,
                    'تكلفة - الخبز': 10,
                    'تكلفة - البهارات والتوابل': 11,
                    'تكلفة - الفحم': 12,
                    'تكلفة - الخضار': 13,
                    'تكلفة - الغاز': 14,
                    'فرق الجرد بين بضاعة أول المدة و آخر المدة': 15,
                    'مجمل الربح قبل تنزيل مصاريف التشغيل': 16,
                    'مصاريف رواتب واجور': 17,
                    'مصاريف أعمال أضافية': 18,
                    'مصاريف توالف المواد': 19,
                    'مصاريف صيانة': 20,
                    'مصاريف نظافة': 21,
                    'مصاريف لوازم العمال': 22,
                    'مصاريف لوازم المطاعم': 23,
                    'مصاريف قرطاسية ومطبوعات': 24,
                    'مصاريف وجبات عاملين': 25,
                    'باقي مصاريف التشغيل': 26,
                    'مجموع مصاريف التشغيل': 27,
                    'الربح قبل تنزيل المصاريف العمومية': 28,
                    'المصاريف العمومية': 29,
                    'صافى الربح': 30
                };
                
                // قراءة البيانات من الخلايا
                Object.entries(accountRows).forEach(([accountName, rowIndex]) => {
                    const cellValue = excelData[rowIndex]?.[colIndex];
                    if (cellValue !== null && cellValue !== undefined && cellValue !== '') {
                        const value = parseFloat(cellValue);
                        if (!isNaN(value)) {
                            const key = this.columnMapping[accountName];
                            if (key) {
                                monthData[key] = value;
                            }
                        }
                    }
                });
                
                // تطبيق معادلات Excel يدوياً بناءً على المثال
                // 1. إجمالي تكلفة المواد = مجموع التكاليف الفرعية (من الصف 6 إلى 14)
                const materialCostsSum = 
                    (monthData.foodCost || 0) +
                    (monthData.meatCost || 0) +
                    (monthData.drinksCost || 0) +
                    (monthData.packagingCost || 0) +
                    (monthData.breadCost || 0) +
                    (monthData.spicesCost || 0) +
                    (monthData.coalCost || 0) +
                    (monthData.vegetablesCost || 0) +
                    (monthData.gasCost || 0);
                
                // إذا كان إجمالي تكلفة المواد فارغاً، استخدم المجموع
                if ((!monthData.totalMaterialCost || monthData.totalMaterialCost === 0) && materialCostsSum > 0) {
                    monthData.totalMaterialCost = materialCostsSum;
                }
                
                // 2. مجمل الربح = المبيعات - إجمالي تكلفة المواد
                const calculatedGrossProfit = (monthData.sales || 0) - (monthData.totalMaterialCost || 0);
                if ((!monthData.grossProfit || monthData.grossProfit === 0) && calculatedGrossProfit !== 0) {
                    monthData.grossProfit = calculatedGrossProfit;
                }
                
                // 3. مجموع مصاريف التشغيل = مجموع مصاريف التشغيل الفرعية (من الصف 17 إلى 26)
                const operatingCostsSum = 
                    (monthData.salariesCost || 0) +
                    (monthData.extraWorkCost || 0) +
                    (monthData.wasteCost || 0) +
                    (monthData.maintenanceCost || 0) +
                    (monthData.cleaningCost || 0) +
                    (monthData.workersSuppliesCost || 0) +
                    (monthData.restaurantSuppliesCost || 0) +
                    (monthData.stationeryCost || 0) +
                    (monthData.workersMealsCost || 0) +
                    (monthData.otherOperatingCost || 0);
                
                // إذا كان مجموع مصاريف التشغيل فارغاً، استخدم المجموع
                if ((!monthData.totalOperatingCost || monthData.totalOperatingCost === 0) && operatingCostsSum > 0) {
                    monthData.totalOperatingCost = operatingCostsSum;
                }
                
                // 4. الربح قبل المصاريف العمومية = مجمل الربح - مجموع مصاريف التشغيل
                const calculatedProfitBeforeGeneral = (monthData.grossProfit || 0) - (monthData.totalOperatingCost || 0);
                if ((!monthData.profitBeforeGeneral || monthData.profitBeforeGeneral === 0) && calculatedProfitBeforeGeneral !== 0) {
                    monthData.profitBeforeGeneral = calculatedProfitBeforeGeneral;
                }
                
                // 5. صافي الربح = الربح قبل المصاريف العمومية - المصاريف العمومية
                const calculatedNetProfit = (monthData.profitBeforeGeneral || 0) - (monthData.generalExpenses || 0);
                if ((!monthData.netProfit || monthData.netProfit === 0) && calculatedNetProfit !== 0) {
                    monthData.netProfit = calculatedNetProfit;
                }
                
                // حساب إجمالي التكاليف
                monthData.totalCosts = 
                    (monthData.totalMaterialCost || 0) +
                    (monthData.totalOperatingCost || 0) +
                    (monthData.generalExpenses || 0);
                
                // حساب هامش الربح
                monthData.profitMargin = monthData.sales > 0 ? 
                    (monthData.netProfit / monthData.sales) * 100 : 0;
                
                return monthData;
            }

            calculateAnnualData(monthlyData) {
                const annualData = {
                    sales: 0,
                    totalMaterialCost: 0,
                    foodCost: 0,
                    meatCost: 0,
                    drinksCost: 0,
                    packagingCost: 0,
                    breadCost: 0,
                    spicesCost: 0,
                    coalCost: 0,
                    vegetablesCost: 0,
                    gasCost: 0,
                    inventoryDifference: 0,
                    grossProfit: 0,
                    salariesCost: 0,
                    extraWorkCost: 0,
                    wasteCost: 0,
                    maintenanceCost: 0,
                    cleaningCost: 0,
                    workersSuppliesCost: 0,
                    restaurantSuppliesCost: 0,
                    stationeryCost: 0,
                    workersMealsCost: 0,
                    otherOperatingCost: 0,
                    totalOperatingCost: 0,
                    profitBeforeGeneral: 0,
                    generalExpenses: 0,
                    netProfit: 0,
                    totalCosts: 0,
                    profitMargin: 0
                };
                
                // جمع البيانات الشهرية
                Object.values(monthlyData).forEach(month => {
                    Object.keys(annualData).forEach(key => {
                        if (key !== 'profitMargin') {
                            annualData[key] += month[key] || 0;
                        }
                    });
                });
                
                // حساب هامش الربح السنوي
                annualData.profitMargin = annualData.sales > 0 ? 
                    (annualData.netProfit / annualData.sales) * 100 : 0;
                
                return annualData;
            }

            calculateRestaurantTotals(monthlyData) {
                const totals = {
                    annualSales: 0,
                    annualTotalMaterialCost: 0,
                    annualGrossProfit: 0,
                    annualTotalOperatingCost: 0,
                    annualProfitBeforeGeneral: 0,
                    annualGeneralExpenses: 0,
                    annualNetProfit: 0,
                    annualTotalCosts: 0,
                    profitMargin: 0,
                    monthlyAverages: {}
                };
                
                // جمع البيانات الشهرية
                const monthCount = Object.keys(monthlyData).length;
                
                Object.values(monthlyData).forEach(month => {
                    totals.annualSales += month.sales || 0;
                    totals.annualTotalMaterialCost += month.totalMaterialCost || 0;
                    totals.annualGrossProfit += month.grossProfit || 0;
                    totals.annualTotalOperatingCost += month.totalOperatingCost || 0;
                    totals.annualProfitBeforeGeneral += month.profitBeforeGeneral || 0;
                    totals.annualGeneralExpenses += month.generalExpenses || 0;
                    totals.annualNetProfit += month.netProfit || 0;
                    totals.annualTotalCosts += month.totalCosts || 0;
                });
                
                // حساب المتوسطات الشهرية
                if (monthCount > 0) {
                    totals.monthlyAverages = {
                        sales: totals.annualSales / monthCount,
                        totalMaterialCost: totals.annualTotalMaterialCost / monthCount,
                        grossProfit: totals.annualGrossProfit / monthCount,
                        totalOperatingCost: totals.annualTotalOperatingCost / monthCount,
                        profitBeforeGeneral: totals.annualProfitBeforeGeneral / monthCount,
                        generalExpenses: totals.annualGeneralExpenses / monthCount,
                        netProfit: totals.annualNetProfit / monthCount,
                        totalCosts: totals.annualTotalCosts / monthCount
                    };
                }
                
                // حساب هامش الربح السنوي
                totals.profitMargin = totals.annualSales > 0 ? 
                    (totals.annualNetProfit / totals.annualSales) * 100 : 0;
                
                return totals;
            }
        }

        // Data Manager
        class DataManager {
            constructor() {
                this.excelParser = new ExcelParser();
                this.restaurants = [];
                this.monthlyData = {};
                this.companyTotals = {
                    totalSales: 0,
                    totalCost: 0,
                    totalProfit: 0,
                    totalRestaurants: 0,
                    averageProfit: 0,
                    profitMargin: 0,
                    bestRestaurant: "",
                    bestManager: ""
                };
                this.planningData = {};
                this.planningPercentages = this.getDefaultPercentages();
            }

            getDefaultPercentages() {
                return {
                    // نسبة المبيعات
                    salesPercentage: 5,
                    
                    // نسب التكاليف الفرعية (المادية)
                    foodCostPercentage: 3,
                    meatCostPercentage: 3,
                    drinksCostPercentage: 3,
                    packagingCostPercentage: 3,
                    breadCostPercentage: 3,
                    spicesCostPercentage: 3,
                    coalCostPercentage: 3,
                    vegetablesCostPercentage: 3,
                    gasCostPercentage: 3,
                    
                    // نسب مصاريف التشغيل
                    salariesCostPercentage: 3,
                    extraWorkCostPercentage: 3,
                    wasteCostPercentage: 3,
                    maintenanceCostPercentage: 3,
                    cleaningCostPercentage: 3,
                    workersSuppliesCostPercentage: 3,
                    restaurantSuppliesCostPercentage: 3,
                    stationeryCostPercentage: 3,
                    workersMealsCostPercentage: 3,
                    otherOperatingCostPercentage: 3,
                    
                    // نسب أخرى
                    inventoryDifferencePercentage: 0,
                    generalExpensesPercentage: 3
                };
            }

            async loadExcelFile(file) {
                try {
                    this.restaurants = await this.excelParser.parseExcel(file);
                    this.processLoadedData();
                    this.calculateCompanyTotals();
                    this.saveToLocalStorage();
                    return true;
                } catch (error) {
                    console.error('Error loading Excel file:', error);
                    throw error;
                }
            }

            processLoadedData() {
                this.monthlyData = {};
                
                this.restaurants.forEach(restaurant => {
                    Object.entries(restaurant.monthlyData).forEach(([month, data]) => {
                        if (!this.monthlyData[month]) {
                            this.monthlyData[month] = {
                                totalSales: 0,
                                totalCost: 0,
                                totalProfit: 0,
                                restaurantCount: 0,
                                restaurants: []
                            };
                        }
                        
                        this.monthlyData[month].totalSales += data.sales || 0;
                        this.monthlyData[month].totalCost += data.totalCosts || 0;
                        this.monthlyData[month].totalProfit += data.netProfit || 0;
                        this.monthlyData[month].restaurantCount++;
                        this.monthlyData[month].restaurants.push({
                            name: restaurant.name,
                            sales: data.sales || 0,
                            profit: data.netProfit || 0,
                            margin: data.profitMargin || 0,
                            areaManager: restaurant.areaManager,
                            operationsManager: restaurant.operationsManager,
                            monthData: data
                        });
                    });
                });
            }

            calculateCompanyTotals() {
                let totalSales = 0;
                let totalCost = 0;
                let totalProfit = 0;
                let bestRestaurant = null;
                let bestManager = null;
                let maxProfit = 0;
                let managerProfits = {};
                
                this.restaurants.forEach(restaurant => {
                    const totals = restaurant.totals;
                    
                    totalSales += totals.annualSales || 0;
                    totalProfit += totals.annualNetProfit || 0;
                    totalCost += totals.annualTotalCosts || 0;
                    
                    if (totals.annualNetProfit > maxProfit) {
                        maxProfit = totals.annualNetProfit;
                        bestRestaurant = restaurant.name;
                    }
                    
                    if (!managerProfits[restaurant.areaManager]) {
                        managerProfits[restaurant.areaManager] = 0;
                    }
                    managerProfits[restaurant.areaManager] += totals.annualNetProfit || 0;
                });
                
                let maxManagerProfit = 0;
                Object.entries(managerProfits).forEach(([manager, profit]) => {
                    if (profit > maxManagerProfit) {
                        maxManagerProfit = profit;
                        bestManager = manager;
                    }
                });
                
                this.companyTotals = {
                    totalSales,
                    totalCost,
                    totalProfit,
                    totalRestaurants: this.restaurants.length,
                    averageProfit: this.restaurants.length > 0 ? totalProfit / this.restaurants.length : 0,
                    profitMargin: totalSales > 0 ? (totalProfit / totalSales) * 100 : 0,
                    bestRestaurant,
                    bestManager
                };
            }

            getRestaurantData(id) {
                const restaurant = this.restaurants.find(r => r.id === id);
                if (!restaurant) return null;
                
                return {
                    ...restaurant,
                    performance: this.getPerformanceLevel(restaurant.totals.profitMargin)
                };
            }

            getPerformanceLevel(margin) {
                if (margin > 30) return { level: 'ممتاز', color: '#50C878', class: 'badge-success' };
                if (margin > 20) return { level: 'جيد جداً', color: '#4A90E2', class: 'badge-primary' };
                if (margin > 10) return { level: 'جيد', color: '#FFB74D', class: 'badge-warning' };
                if (margin > 0) return { level: 'مقبول', color: '#9B59B6', class: 'badge-secondary' };
                return { level: 'ضعيف', color: '#FF6B6B', class: 'badge-danger' };
            }

            getTopRestaurants(limit = 5) {
                const filtered = this.restaurants.filter(r => r.totals.profitMargin > 0);
                return [...filtered]
                    .sort((a, b) => b.totals.profitMargin - a.totals.profitMargin)
                    .slice(0, limit)
                    .map(rest => ({
                        id: rest.id,
                        name: rest.name,
                        areaManager: rest.areaManager,
                        operationsManager: rest.operationsManager,
                        annualSales: rest.totals.annualSales,
                        annualProfit: rest.totals.annualNetProfit,
                        profitMargin: rest.totals.profitMargin
                    }));
            }

            getBottomRestaurants(limit = 5) {
                const filtered = this.restaurants.filter(r => r.totals.profitMargin <= 0);
                if (filtered.length === 0) {
                    return [...this.restaurants]
                        .sort((a, b) => a.totals.profitMargin - b.totals.profitMargin)
                        .slice(0, limit)
                        .map(rest => ({
                            id: rest.id,
                            name: rest.name,
                            areaManager: rest.areaManager,
                            operationsManager: rest.operationsManager,
                            annualSales: rest.totals.annualSales,
                            annualProfit: rest.totals.annualNetProfit,
                            profitMargin: rest.totals.profitMargin
                        }));
                }
                
                return [...filtered]
                    .sort((a, b) => a.totals.profitMargin - b.totals.profitMargin)
                    .slice(0, limit)
                    .map(rest => ({
                        id: rest.id,
                        name: rest.name,
                        areaManager: rest.areaManager,
                        operationsManager: rest.operationsManager,
                        annualSales: rest.totals.annualSales,
                        annualProfit: rest.totals.annualNetProfit,
                        profitMargin: rest.totals.profitMargin
                    }));
            }

            getAllMonthlyData() {
                return this.monthlyData;
            }

            getManagersData() {
                const managers = {};
                
                this.restaurants.forEach(restaurant => {
                    if (!managers[restaurant.areaManager]) {
                        managers[restaurant.areaManager] = {
                            name: restaurant.areaManager,
                            type: 'مدير منطقة',
                            restaurants: [],
                            totalSales: 0,
                            totalProfit: 0,
                            restaurantCount: 0
                        };
                    }
                    managers[restaurant.areaManager].restaurants.push(restaurant.name);
                    managers[restaurant.areaManager].restaurantCount++;
                    managers[restaurant.areaManager].totalSales += restaurant.totals.annualSales;
                    managers[restaurant.areaManager].totalProfit += restaurant.totals.annualNetProfit;
                    
                    if (!managers[restaurant.operationsManager]) {
                        managers[restaurant.operationsManager] = {
                            name: restaurant.operationsManager,
                            type: 'مدير تشغيل',
                            restaurants: [],
                            totalSales: 0,
                            totalProfit: 0,
                            restaurantCount: 0
                        };
                    }
                    managers[restaurant.operationsManager].restaurants.push(restaurant.name);
                    managers[restaurant.operationsManager].restaurantCount++;
                    managers[restaurant.operationsManager].totalSales += restaurant.totals.annualSales;
                    managers[restaurant.operationsManager].totalProfit += restaurant.totals.annualNetProfit;
                });
                
                Object.values(managers).forEach(manager => {
                    manager.averageProfit = manager.restaurantCount > 0 ? 
                        manager.totalProfit / manager.restaurantCount : 0;
                    manager.profitMargin = manager.totalSales > 0 ? 
                        (manager.totalProfit / manager.totalSales) * 100 : 0;
                });
                
                return managers;
            }

            getCostAnalysis() {
                const analysis = {
                    totalFoodCost: 0,
                    totalLaborCost: 0,
                    totalRent: 0,
                    totalUtilities: 0,
                    totalOtherCosts: 0,
                    restaurants: []
                };
                
                this.restaurants.forEach(restaurant => {
                    const annualData = restaurant.annualData;
                    const restaurantCosts = {
                        name: restaurant.name,
                        areaManager: restaurant.areaManager,
                        operationsManager: restaurant.operationsManager,
                        foodCost: (annualData.foodCost || 0) + (annualData.meatCost || 0) + (annualData.vegetablesCost || 0) + 
                                 (annualData.breadCost || 0) + (annualData.spicesCost || 0),
                        laborCost: annualData.salariesCost || 0,
                        rent: 0,
                        utilities: (annualData.gasCost || 0) + (annualData.coalCost || 0),
                        otherCosts: (annualData.packagingCost || 0) + (annualData.drinksCost || 0) + 
                                   (annualData.maintenanceCost || 0) + (annualData.cleaningCost || 0) +
                                   (annualData.stationeryCost || 0),
                        totalCost: 0
                    };
                    
                    restaurantCosts.totalCost = restaurantCosts.foodCost + restaurantCosts.laborCost + 
                                               restaurantCosts.utilities + restaurantCosts.otherCosts;
                    
                    analysis.totalFoodCost += restaurantCosts.foodCost;
                    analysis.totalLaborCost += restaurantCosts.laborCost;
                    analysis.totalUtilities += restaurantCosts.utilities;
                    analysis.totalOtherCosts += restaurantCosts.otherCosts;
                    analysis.restaurants.push(restaurantCosts);
                });
                
                analysis.totalCost = analysis.totalFoodCost + analysis.totalLaborCost + 
                                    analysis.totalUtilities + analysis.totalOtherCosts;
                
                return analysis;
            }

            getAllCostDetails() {
                const allCosts = [];
                
                this.restaurants.forEach(restaurant => {
                    const annualData = restaurant.annualData;
                    
                    const costDetails = {
                        name: restaurant.name,
                        areaManager: restaurant.areaManager,
                        operationsManager: restaurant.operationsManager,
                        totalMaterialCost: annualData.totalMaterialCost || 0,
                        foodCost: annualData.foodCost || 0,
                        meatCost: annualData.meatCost || 0,
                        drinksCost: annualData.drinksCost || 0,
                        packagingCost: annualData.packagingCost || 0,
                        breadCost: annualData.breadCost || 0,
                        spicesCost: annualData.spicesCost || 0,
                        coalCost: annualData.coalCost || 0,
                        vegetablesCost: annualData.vegetablesCost || 0,
                        gasCost: annualData.gasCost || 0,
                        salariesCost: annualData.salariesCost || 0,
                        extraWorkCost: annualData.extraWorkCost || 0,
                        wasteCost: annualData.wasteCost || 0,
                        maintenanceCost: annualData.maintenanceCost || 0,
                        cleaningCost: annualData.cleaningCost || 0,
                        workersSuppliesCost: annualData.workersSuppliesCost || 0,
                        restaurantSuppliesCost: annualData.restaurantSuppliesCost || 0,
                        stationeryCost: annualData.stationeryCost || 0,
                        workersMealsCost: annualData.workersMealsCost || 0,
                        otherOperatingCost: annualData.otherOperatingCost || 0,
                        totalOperatingCost: annualData.totalOperatingCost || 0,
                        generalExpenses: annualData.generalExpenses || 0
                    };
                    
                    allCosts.push(costDetails);
                });
                
                return allCosts;
            }

            saveToLocalStorage() {
                const data = {
                    restaurants: this.restaurants,
                    monthlyData: this.monthlyData,
                    companyTotals: this.companyTotals,
                    planningPercentages: this.planningPercentages,
                    lastUpdated: new Date().toISOString()
                };
                
                localStorage.setItem('naifFoodAnalytics', JSON.stringify(data));
            }

            loadFromLocalStorage() {
                const savedData = localStorage.getItem('naifFoodAnalytics');
                
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        this.restaurants = data.restaurants || [];
                        this.monthlyData = data.monthlyData || {};
                        this.companyTotals = data.companyTotals || this.companyTotals;
                        this.planningPercentages = data.planningPercentages || this.getDefaultPercentages();
                    } catch (error) {
                        console.error('Error loading from localStorage:', error);
                        this.restaurants = [];
                        this.planningPercentages = this.getDefaultPercentages();
                    }
                }
            }

            getUniqueManagers() {
                const managers = {
                    areaManagers: [],
                    operationsManagers: []
                };
                
                this.restaurants.forEach(restaurant => {
                    if (!managers.areaManagers.includes(restaurant.areaManager)) {
                        managers.areaManagers.push(restaurant.areaManager);
                    }
                    if (!managers.operationsManagers.includes(restaurant.operationsManager)) {
                        managers.operationsManagers.push(restaurant.operationsManager);
                    }
                });
                
                return managers;
            }

            getNovemberData(restaurant) {
                const novemberData = restaurant.monthlyData['نوفمبر 2025'];
                if (novemberData) {
                    return novemberData;
                }
                
                // إذا لم يكن هناك بيانات لشهر نوفمبر، استخدم آخر شهر متاح
                const months = Object.keys(restaurant.monthlyData);
                if (months.length > 0) {
                    const lastMonth = months[months.length - 1];
                    return restaurant.monthlyData[lastMonth];
                }
                
                // إذا لم يكن هناك أي بيانات شهرية، استخدم المتوسطات السنوية
                return {
                    sales: restaurant.totals.monthlyAverages.sales || 0,
                    totalMaterialCost: restaurant.totals.monthlyAverages.totalMaterialCost || 0,
                    foodCost: restaurant.totals.monthlyAverages.foodCost || 0,
                    meatCost: restaurant.totals.monthlyAverages.meatCost || 0,
                    drinksCost: restaurant.totals.monthlyAverages.drinksCost || 0,
                    packagingCost: restaurant.totals.monthlyAverages.packagingCost || 0,
                    breadCost: restaurant.totals.monthlyAverages.breadCost || 0,
                    spicesCost: restaurant.totals.monthlyAverages.spicesCost || 0,
                    coalCost: restaurant.totals.monthlyAverages.coalCost || 0,
                    vegetablesCost: restaurant.totals.monthlyAverages.vegetablesCost || 0,
                    gasCost: restaurant.totals.monthlyAverages.gasCost || 0,
                    inventoryDifference: restaurant.totals.monthlyAverages.inventoryDifference || 0,
                    grossProfit: restaurant.totals.monthlyAverages.grossProfit || 0,
                    salariesCost: restaurant.totals.monthlyAverages.salariesCost || 0,
                    extraWorkCost: restaurant.totals.monthlyAverages.extraWorkCost || 0,
                    wasteCost: restaurant.totals.monthlyAverages.wasteCost || 0,
                    maintenanceCost: restaurant.totals.monthlyAverages.maintenanceCost || 0,
                    cleaningCost: restaurant.totals.monthlyAverages.cleaningCost || 0,
                    workersSuppliesCost: restaurant.totals.monthlyAverages.workersSuppliesCost || 0,
                    restaurantSuppliesCost: restaurant.totals.monthlyAverages.restaurantSuppliesCost || 0,
                    stationeryCost: restaurant.totals.monthlyAverages.stationeryCost || 0,
                    workersMealsCost: restaurant.totals.monthlyAverages.workersMealsCost || 0,
                    otherOperatingCost: restaurant.totals.monthlyAverages.otherOperatingCost || 0,
                    totalOperatingCost: restaurant.totals.monthlyAverages.totalOperatingCost || 0,
                    profitBeforeGeneral: restaurant.totals.monthlyAverages.profitBeforeGeneral || 0,
                    generalExpenses: restaurant.totals.monthlyAverages.generalExpenses || 0,
                    netProfit: restaurant.totals.monthlyAverages.netProfit || 0
                };
            }

            calculateMonthValue(novemberValue, percentage, targetMonthDays, baseMonthDays = 30) {
                // الحساب: (قيمة نوفمبر / 30 * عدد أيام الشهر الهدف) * (1 + النسبة/100)
                if (!novemberValue || novemberValue === 0) return 0;
                
                const dailyValue = novemberValue / baseMonthDays;
                const daysAdjustedValue = dailyValue * targetMonthDays;
                const percentageAdjustedValue = daysAdjustedValue * (1 + (percentage / 100));
                
                return Math.round(percentageAdjustedValue * 100) / 100;
            }

            generatePlanningTemplate2026() {
                if (this.restaurants.length === 0) {
                    throw new Error('لا توجد بيانات مطاعم. يرجى تحميل ملف Excel أولاً.');
                }
                
                const wb = XLSX.utils.book_new();
                const months2026 = [
                    { name: 'يناير 2026', days: 31 },
                    { name: 'فبراير 2026', days: 28 }, // 2026 ليست سنة كبيسة
                    { name: 'يناير 2026', days: 31 },
                    { name: 'أبريل 2026', days: 30 },
                    { name: 'مايو 2026', days: 31 },
                    { name: 'يونيو 2026', days: 30 },
                    { name: 'يوليو 2026', days: 31 },
                    { name: 'أغسطس 2026', days: 31 },
                    { name: 'سبتمبر 2026', days: 30 },
                    { name: 'أكتوبر 2026', days: 31 },
                    { name: 'نوفمبر 2026', days: 30 },
                    { name: 'ديسمبر 2026', days: 31 }
                ];
                
                // إنشاء شيت لكل مطعم
                this.restaurants.forEach((restaurant, index) => {
                    const novemberData = this.getNovemberData(restaurant);
                    const sheetName = this.getValidSheetName(restaurant.name, index);
                    
                    // إنشاء البيانات للشيت
                    const sheetData = [];
                    
                    // صفوف المعلومات
                    sheetData.push(['مدير التشغيل:', restaurant.operationsManager]);
                    sheetData.push(['مدير المنطقة:', restaurant.areaManager]);
                    sheetData.push(['اسم المطعم:', restaurant.name]);
                    sheetData.push(['ملاحظة: جميع القيم محسوبة بناءً على بيانات نوفمبر 2025 مع تطبيق النسب المحددة وتعديل عدد الأيام']);
                    sheetData.push(['']);
                    
                    // رؤوس الجدول
                    const headers = ['الحسابات', ...months2026.map(m => m.name), 'الإجمالي السنوي'];
                    sheetData.push(headers);
                    
                    // تعريف الحسابات ونسبها
                    const accounts = [
                        { name: 'المبيعات', key: 'sales', percentage: this.planningPercentages.salesPercentage },
                        { name: 'اجمالي تكلفة المواد المباعة', key: 'totalMaterialCost', percentage: 0, isCalculated: true },
                        { name: 'تكلفة - المواد الغذائية - المخازن', key: 'foodCost', percentage: this.planningPercentages.foodCostPercentage },
                        { name: 'تكلفة - اللحوم والمقبلات', key: 'meatCost', percentage: this.planningPercentages.meatCostPercentage },
                        { name: 'تكلفة - المرطبات', key: 'drinksCost', percentage: this.planningPercentages.drinksCostPercentage },
                        { name: 'تكلفة - التعبئة والتغليف', key: 'packagingCost', percentage: this.planningPercentages.packagingCostPercentage },
                        { name: 'تكلفة - الخبز', key: 'breadCost', percentage: this.planningPercentages.breadCostPercentage },
                        { name: 'تكلفة - البهارات والتوابل', key: 'spicesCost', percentage: this.planningPercentages.spicesCostPercentage },
                        { name: 'تكلفة - الفحم', key: 'coalCost', percentage: this.planningPercentages.coalCostPercentage },
                        { name: 'تكلفة - الخضار', key: 'vegetablesCost', percentage: this.planningPercentages.vegetablesCostPercentage },
                        { name: 'تكلفة - الغاز', key: 'gasCost', percentage: this.planningPercentages.gasCostPercentage },
                        { name: 'فرق الجرد بين بضاعة أول المدة و آخر المدة', key: 'inventoryDifference', percentage: this.planningPercentages.inventoryDifferencePercentage },
                        { name: 'مجمل الربح قبل تنزيل مصاريف التشغيل', key: 'grossProfit', percentage: 0, isCalculated: true },
                        { name: 'مصاريف رواتب واجور', key: 'salariesCost', percentage: this.planningPercentages.salariesCostPercentage },
                        { name: 'مصاريف أعمال أضافية', key: 'extraWorkCost', percentage: this.planningPercentages.extraWorkCostPercentage },
                        { name: 'مصاريف توالف المواد', key: 'wasteCost', percentage: this.planningPercentages.wasteCostPercentage },
                        { name: 'مصاريف صيانة', key: 'maintenanceCost', percentage: this.planningPercentages.maintenanceCostPercentage },
                        { name: 'مصاريف نظافة', key: 'cleaningCost', percentage: this.planningPercentages.cleaningCostPercentage },
                        { name: 'مصاريف لوازم العمال', key: 'workersSuppliesCost', percentage: this.planningPercentages.workersSuppliesCostPercentage },
                        { name: 'مصاريف لوازم المطاعم', key: 'restaurantSuppliesCost', percentage: this.planningPercentages.restaurantSuppliesCostPercentage },
                        { name: 'مصاريف قرطاسية ومطبوعات', key: 'stationeryCost', percentage: this.planningPercentages.stationeryCostPercentage },
                        { name: 'مصاريف وجبات عاملين', key: 'workersMealsCost', percentage: this.planningPercentages.workersMealsCostPercentage },
                        { name: 'باقي مصاريف التشغيل', key: 'otherOperatingCost', percentage: this.planningPercentages.otherOperatingCostPercentage },
                        { name: 'مجموع مصاريف التشغيل', key: 'totalOperatingCost', percentage: 0, isCalculated: true },
                        { name: 'الربح قبل تنزيل المصاريف العمومية', key: 'profitBeforeGeneral', percentage: 0, isCalculated: true },
                        { name: 'المصاريف العمومية', key: 'generalExpenses', percentage: this.planningPercentages.generalExpensesPercentage },
                        { name: 'صافى الربح', key: 'netProfit', percentage: 0, isCalculated: true }
                    ];
                    
                    // حساب البيانات الشهرية
                    const monthlyValues = {};
                    accounts.forEach(account => {
                        if (!account.isCalculated) {
                            monthlyValues[account.key] = months2026.map(month => 
                                this.calculateMonthValue(novemberData[account.key], account.percentage, month.days)
                            );
                        }
                    });
                    
                    // حساب القيم المحسوبة
                    // إجمالي تكلفة المواد = مجموع التكاليف الفرعية
                    monthlyValues.totalMaterialCost = [];
                    for (let i = 0; i < 12; i++) {
                        let total = 0;
                        total += monthlyValues.foodCost[i];
                        total += monthlyValues.meatCost[i];
                        total += monthlyValues.drinksCost[i];
                        total += monthlyValues.packagingCost[i];
                        total += monthlyValues.breadCost[i];
                        total += monthlyValues.spicesCost[i];
                        total += monthlyValues.coalCost[i];
                        total += monthlyValues.vegetablesCost[i];
                        total += monthlyValues.gasCost[i];
                        monthlyValues.totalMaterialCost.push(total);
                    }
                    
                    // مجمل الربح = المبيعات - إجمالي تكلفة المواد
                    monthlyValues.grossProfit = months2026.map((_, i) => 
                        monthlyValues.sales[i] - monthlyValues.totalMaterialCost[i]
                    );
                    
                    // مجموع مصاريف التشغيل = مجموع مصاريف التشغيل الفرعية
                    monthlyValues.totalOperatingCost = [];
                    for (let i = 0; i < 12; i++) {
                        let total = 0;
                        total += monthlyValues.salariesCost[i];
                        total += monthlyValues.extraWorkCost[i];
                        total += monthlyValues.wasteCost[i];
                        total += monthlyValues.maintenanceCost[i];
                        total += monthlyValues.cleaningCost[i];
                        total += monthlyValues.workersSuppliesCost[i];
                        total += monthlyValues.restaurantSuppliesCost[i];
                        total += monthlyValues.stationeryCost[i];
                        total += monthlyValues.workersMealsCost[i];
                        total += monthlyValues.otherOperatingCost[i];
                        monthlyValues.totalOperatingCost.push(total);
                    }
                    
                    // الربح قبل العمومية = مجمل الربح - مجموع مصاريف التشغيل
                    monthlyValues.profitBeforeGeneral = months2026.map((_, i) => 
                        monthlyValues.grossProfit[i] - monthlyValues.totalOperatingCost[i]
                    );
                    
                    // صافي الربح = الربح قبل العمومية - المصاريف العمومية
                    monthlyValues.netProfit = months2026.map((_, i) => 
                        monthlyValues.profitBeforeGeneral[i] - monthlyValues.generalExpenses[i]
                    );
                    
                    // إضافة البيانات إلى الشيت
                    accounts.forEach(account => {
                        const rowData = [account.name];
                        let annualTotal = 0;
                        
                        const values = monthlyValues[account.key];
                        values.forEach(value => {
                            rowData.push(value);
                            annualTotal += value;
                        });
                        
                        rowData.push(annualTotal);
                        sheetData.push(rowData);
                    });
                    
                    // إنشاء الورقة
                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    
                    // تعيين أعمدة العرض
                    const wscols = [
                        { wch: 40 }, // أسماء الحسابات
                        ...months2026.map(() => ({ wch: 15 })), // الأشهر
                        { wch: 15 } // الإجمالي السنوي
                    ];
                    ws['!cols'] = wscols;
                    
                    // إضافة الورقة إلى الملف
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });
                
                // إنشاء شيت الملخص
                this.createSummarySheet2026(wb);
                
                // إنشاء شيت نسب التخطيط
                this.createPlanningPercentagesSheet(wb);
                
                return wb;
            }
            
            getValidSheetName(name, index) {
                let sheetName = name.replace(/[\\/*?:[\]]/g, '_');
                if (sheetName.length > 31) {
                    sheetName = sheetName.substring(0, 28) + '...';
                }
                if (sheetName === '' || sheetName === '_') {
                    sheetName = `مطعم_${index + 1}`;
                }
                return sheetName;
            }
            
            createSummarySheet2026(wb) {
                const summaryData = [
                    ['ملخص خطة 2026 - شركة نايف للأغذية'],
                    ['تاريخ الإنشاء:', new Date().toLocaleDateString('ar-SA')],
                    ['ملاحظة: جميع القيم محسوبة بناءً على بيانات نوفمبر 2025 مع تطبيق النسب المحددة وتعديل عدد الأيام'],
                    [''],
                    ['المطعم', 'مدير المنطقة', 'المبيعات 2025', 'المبيعات المستهدفة 2026', 'الزيادة %', 
                     'الربح 2025', 'الربح المستهدف 2026', 'هامش الربح 2025', 'هامش الربح المستهدف 2026']
                ];
                
                this.restaurants.forEach(restaurant => {
                    const data = this.getRestaurantData(restaurant.id);
                    const novemberData = this.getNovemberData(restaurant);
                    
                    // حساب المبيعات المستهدفة (متوسط شهري * 12)
                    const targetMonthlySales = this.calculateMonthValue(
                        novemberData.sales, 
                        this.planningPercentages.salesPercentage, 
                        30
                    );
                    const targetAnnualSales = targetMonthlySales * 12;
                    
                    // حساب الربح المستهدف (متوسط شهري * 12)
                    const targetMonthlyProfit = this.calculateMonthValue(
                        novemberData.netProfit, 
                        0, // النسبة للربح حسب المعادلات
                        30
                    );
                    const targetAnnualProfit = targetMonthlyProfit * 12;
                    
                    // حساب هامش الربح المستهدف
                    const targetProfitMargin = targetAnnualSales > 0 ? 
                        (targetAnnualProfit / targetAnnualSales) * 100 : 0;
                    
                    summaryData.push([
                        restaurant.name,
                        restaurant.areaManager,
                        data.totals.annualSales,
                        Math.round(targetAnnualSales * 100) / 100,
                        `${this.planningPercentages.salesPercentage}%`,
                        data.totals.annualNetProfit,
                        Math.round(targetAnnualProfit * 100) / 100,
                        `${data.totals.profitMargin.toFixed(2)}%`,
                        `${targetProfitMargin.toFixed(2)}%`
                    ]);
                });
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, 'ملخص_الشركة');
            }
            
            createPlanningPercentagesSheet(wb) {
                const percentagesData = [
                    ['نسب التخطيط المستخدمة - خطة 2026'],
                    ['تاريخ الإنشاء:', new Date().toLocaleDateString('ar-SA')],
                    ['ملاحظة: جميع النسب تطبق على بيانات نوفمبر 2025 مع تعديل عدد الأيام'],
                    [''],
                    ['نوع الحساب', 'النسبة %', 'الوصف']
                ];
                
                const percentageGroups = [
                    {
                        title: 'المبيعات',
                        items: [
                            { name: 'المبيعات', value: this.planningPercentages.salesPercentage, desc: 'نسبة زيادة المبيعات' }
                        ]
                    },
                    {
                        title: 'التكاليف المادية',
                        items: [
                            { name: 'تكلفة المواد الغذائية', value: this.planningPercentages.foodCostPercentage, desc: 'تكلفة المواد الغذائية - المخازن' },
                            { name: 'تكلفة اللحوم', value: this.planningPercentages.meatCostPercentage, desc: 'تكلفة اللحوم والمقبلات' },
                            { name: 'تكلفة المرطبات', value: this.planningPercentages.drinksCostPercentage, desc: 'تكلفة المرطبات' },
                            { name: 'تكلفة التعبئة', value: this.planningPercentages.packagingCostPercentage, desc: 'تكلفة التعبئة والتغليف' },
                            { name: 'تكلفة الخبز', value: this.planningPercentages.breadCostPercentage, desc: 'تكلفة الخبز' },
                            { name: 'تكلفة البهارات', value: this.planningPercentages.spicesCostPercentage, desc: 'تكلفة البهارات والتوابل' },
                            { name: 'تكلفة الفحم', value: this.planningPercentages.coalCostPercentage, desc: 'تكلفة الفحم' },
                            { name: 'تكلفة الخضار', value: this.planningPercentages.vegetablesCostPercentage, desc: 'تكلفة الخضار' },
                            { name: 'تكلفة الغاز', value: this.planningPercentages.gasCostPercentage, desc: 'تكلفة الغاز' }
                        ]
                    },
                    {
                        title: 'مصاريف التشغيل',
                        items: [
                            { name: 'رواتب وأجور', value: this.planningPercentages.salariesCostPercentage, desc: 'مصاريف رواتب واجور' },
                            { name: 'أعمال إضافية', value: this.planningPercentages.extraWorkCostPercentage, desc: 'مصاريف أعمال أضافية' },
                            { name: 'توالف المواد', value: this.planningPercentages.wasteCostPercentage, desc: 'مصاريف توالف المواد' },
                            { name: 'الصيانة', value: this.planningPercentages.maintenanceCostPercentage, desc: 'مصاريف صيانة' },
                            { name: 'النظافة', value: this.planningPercentages.cleaningCostPercentage, desc: 'مصاريف نظافة' },
                            { name: 'لوازم العمال', value: this.planningPercentages.workersSuppliesCostPercentage, desc: 'مصاريف لوازم العمال' },
                            { name: 'لوازم المطاعم', value: this.planningPercentages.restaurantSuppliesCostPercentage, desc: 'مصاريف لوازم المطاعم' },
                            { name: 'قرطاسية ومطبوعات', value: this.planningPercentages.stationeryCostPercentage, desc: 'مصاريف قرطاسية ومطبوعات' },
                            { name: 'وجبات العاملين', value: this.planningPercentages.workersMealsCostPercentage, desc: 'مصاريف وجبات عاملين' },
                            { name: 'مصاريف تشغيل أخرى', value: this.planningPercentages.otherOperatingCostPercentage, desc: 'باقي مصاريف التشغيل' }
                        ]
                    },
                    {
                        title: 'حسابات أخرى',
                        items: [
                            { name: 'فرق الجرد', value: this.planningPercentages.inventoryDifferencePercentage, desc: 'فرق الجرد بين بضاعة أول المدة و آخر المدة' },
                            { name: 'مصاريف عمومية', value: this.planningPercentages.generalExpensesPercentage, desc: 'المصاريف العمومية' }
                        ]
                    }
                ];
                
                percentageGroups.forEach(group => {
                    percentagesData.push(['', '', '']);
                    percentagesData.push([group.title, '', '']);
                    group.items.forEach(item => {
                        percentagesData.push([item.name, `${item.value}%`, item.desc]);
                    });
                });
                
                const wsPercentages = XLSX.utils.aoa_to_sheet(percentagesData);
                XLSX.utils.book_append_sheet(wb, wsPercentages, 'نسب_التخطيط');
            }

            savePlanningData(planningData) {
                this.planningData = planningData;
                localStorage.setItem('naifFoodPlanning', JSON.stringify(planningData));
            }

            loadPlanningData() {
                const savedData = localStorage.getItem('naifFoodPlanning');
                if (savedData) {
                    try {
                        this.planningData = JSON.parse(savedData);
                    } catch (error) {
                        console.error('Error loading planning data:', error);
                        this.planningData = {};
                    }
                }
                return this.planningData;
            }

            savePlanningPercentages(percentages) {
                this.planningPercentages = percentages;
                this.saveToLocalStorage();
            }

            getPlanningPercentages() {
                return this.planningPercentages;
            }
        }

        // Helpers
        class Helpers {
            static formatNumber(num) {
                return new Intl.NumberFormat('en-US').format(Math.round(num || 0));
            }
            
            static formatCurrency(amount) {
                if (amount >= 1000000) {
                    return (amount / 1000000).toFixed(2) + ' مليون';
                } else if (amount >= 1000) {
                    return (amount / 1000).toFixed(1) + ' ألف';
                }
                return this.formatNumber(amount) + ' د.ك';
            }
            
            static downloadCSV(content, filename) {
                const blob = new Blob(['\uFEFF' + content], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            static exportToExcel(data, filename) {
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'البيانات');
                XLSX.writeFile(wb, filename);
            }
        }

        // Dashboard
        class Dashboard {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.currentPage = 'dashboard';
                this.charts = {};
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.showDashboard();
                this.updateStats();
                this.updateCurrentDate();
            }
            
            setupEventListeners() {
                document.querySelectorAll('.sidebar-menu li').forEach(item => {
                    item.addEventListener('click', () => {
                        const page = item.dataset.page;
                        this.navigateTo(page);
                    });
                });
                
                setInterval(() => this.updateCurrentDate(), 60000);
            }
            
            navigateTo(page) {
                document.querySelectorAll('.sidebar-menu li').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === page) {
                        item.classList.add('active');
                    }
                });
                
                this.currentPage = page;
                
                switch(page) {
                    case 'dashboard':
                        this.showDashboard();
                        break;
                    case 'monthly-report':
                        this.showMonthlyReport();
                        break;
                    case 'restaurants':
                        this.showRestaurants();
                        break;
                    case 'managers':
                        this.showManagers();
                        break;
                    case 'cost-analysis':
                        this.showCostAnalysis();
                        break;
                    case 'profit-analysis':
                        this.showProfitAnalysis();
                        break;
                    case 'planning':
                        this.showPlanning();
                        break;
                    case 'comparison':
                        this.showComparison();
                        break;
                    case 'export':
                        this.showExport();
                        break;
                }
            }
            
            showDashboard() {
                const totals = this.dataManager.companyTotals;
                const topRestaurants = this.dataManager.getTopRestaurants(5);
                const bottomRestaurants = this.dataManager.getBottomRestaurants(5);
                
                const content = `
                    <div class="dashboard-header">
                        <h1><i class="fas fa-chart-line"></i> لوحة التحكم الرئيسية</h1>
                        <div class="dashboard-actions">
                            <button class="btn btn-primary" id="refresh-btn">
                                <i class="fas fa-sync-alt"></i> تحديث
                            </button>
                        </div>
                    </div>
                    
                    <div class="company-summary">
                        <h2><i class="fas fa-building"></i> ملخص أداء الشركة - 2025</h2>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <i class="fas fa-money-bill-wave"></i>
                                <div>
                                    <div class="value">${Helpers.formatCurrency(totals.totalSales)}</div>
                                    <div class="label">إجمالي المبيعات</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-chart-pie"></i>
                                <div>
                                    <div class="value">${Helpers.formatCurrency(totals.totalProfit)}</div>
                                    <div class="label">صافي الربح</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-percentage"></i>
                                <div>
                                    <div class="value">${totals.profitMargin.toFixed(2)}%</div>
                                    <div class="label">هامش الربح</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-store"></i>
                                <div>
                                    <div class="value">${totals.totalRestaurants}</div>
                                    <div class="label">عدد المطاعم</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-trophy"></i>
                                <div>
                                    <div class="value">${totals.bestRestaurant || 'غير محدد'}</div>
                                    <div class="label">أفضل مطعم</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <i class="fas fa-user-tie"></i>
                                <div>
                                    <div class="value">${totals.bestManager || 'غير محدد'}</div>
                                    <div class="label">أفضل مدير</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="interactive-charts">
                        <div class="chart-card">
                            <div class="chart-card-header">
                                <h3><i class="fas fa-chart-bar"></i> أداء المطاعم الشهري</h3>
                                <select id="chart-month" class="form-select" onchange="dashboard.updateMonthlyChart(this.value)">
                                    <option value="all">جميع الشهور</option>
                                    ${this.generateMonthOptions()}
                                </select>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="monthlyPerformanceChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-card-header">
                                <h3><i class="fas fa-chart-pie"></i> توزيع التكاليف</h3>
                                <select id="cost-restaurant" class="form-select" onchange="dashboard.updateCostChart(this.value)">
                                    <option value="all">إجمالي الشركة</option>
                                    ${this.generateRestaurantOptions()}
                                </select>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="costDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-row">
                        <div class="table-container">
                            <div class="table-header">
                                <h2><i class="fas fa-trophy"></i> أفضل 5 مطاعم أداءً</h2>
                            </div>
                            <div class="table-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>المطعم</th>
                                            <th>مدير المنطقة</th>
                                            <th>المبيعات السنوية</th>
                                            <th>الربح السنوي</th>
                                            <th>هامش الربح</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${topRestaurants.map((rest, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td>${rest.name}</td>
                                                <td>${rest.areaManager}</td>
                                                <td>${Helpers.formatNumber(rest.annualSales)}</td>
                                                <td class="positive">${Helpers.formatNumber(rest.annualProfit)}</td>
                                                <td><span class="badge badge-success">${rest.profitMargin.toFixed(2)}%</span></td>
                                                <td>
                                                    <button class="btn-icon view-restaurant" onclick="dashboard.showRestaurantDetails(${rest.id})">
                                                        <i class="fas fa-eye"></i> عرض
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h2><i class="fas fa-exclamation-triangle"></i> أسوأ 5 مطاعم أداءً</h2>
                            </div>
                            <div class="table-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>المطعم</th>
                                            <th>مدير المنطقة</th>
                                            <th>المبيعات السنوية</th>
                                            <th>الربح السنوي</th>
                                            <th>هامش الربح</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${bottomRestaurants.map((rest, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td>${rest.name}</td>
                                                <td>${rest.areaManager}</td>
                                                <td>${Helpers.formatNumber(rest.annualSales)}</td>
                                                <td class="${rest.annualProfit >= 0 ? 'positive' : 'negative'}">
                                                    ${Helpers.formatNumber(rest.annualProfit)}
                                                </td>
                                                <td><span class="badge ${rest.profitMargin > 0 ? 'badge-warning' : 'badge-danger'}">${rest.profitMargin.toFixed(2)}%</span></td>
                                                <td>
                                                    <button class="btn-icon view-restaurant" onclick="dashboard.showRestaurantDetails(${rest.id})">
                                                        <i class="fas fa-eye"></i> عرض
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
                
                this.setupDashboardEvents();
                
                setTimeout(() => {
                    this.drawMonthlyPerformanceChart('all');
                    this.drawCostDistributionChart('all');
                }, 100);
            }
            
            generateMonthOptions() {
                const months = ["يناير 2025", "فبراير 2025", "مارس 2025", "أبريل 2025", "مايو 2025", "يونيو 2025",
                               "يوليو 2025", "أغسطس 2025", "سبتمبر 2025", "أكتوبر 2025", "نوفمبر 2025", "ديسمبر 2025"];
                return months.map(month => `<option value="${month}">${month}</option>`).join('');
            }
            
            generateRestaurantOptions() {
                return this.dataManager.restaurants.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            }
            
            updateMonthlyChart(month) {
                this.drawMonthlyPerformanceChart(month);
            }
            
            updateCostChart(restaurantId) {
                this.drawCostDistributionChart(restaurantId);
            }
            
            drawMonthlyPerformanceChart(selectedMonth) {
                const ctx = document.getElementById('monthlyPerformanceChart')?.getContext('2d');
                if (!ctx) return;
                
                const months = ["يناير 2025", "فبراير 2025", "مارس 2025", "أبريل 2025", "مايو 2025", "يونيو 2025",
                               "يوليو 2025", "أغسطس 2025", "سبتمبر 2025", "أكتوبر 2025", "نوفمبر 2025", "ديسمبر 2025"];
                const monthlyData = this.dataManager.getAllMonthlyData();
                
                let salesData, profitData;
                
                if (selectedMonth === 'all') {
                    salesData = months.map(month => (monthlyData[month]?.totalSales || 0) / 1000);
                    profitData = months.map(month => (monthlyData[month]?.totalProfit || 0) / 1000);
                } else {
                    const monthData = monthlyData[selectedMonth];
                    salesData = months.map(month => month === selectedMonth ? (monthData?.totalSales || 0) / 1000 : 0);
                    profitData = months.map(month => month === selectedMonth ? (monthData?.totalProfit || 0) / 1000 : 0);
                }
                
                if (this.charts.monthlyPerformance) {
                    this.charts.monthlyPerformance.destroy();
                }
                
                this.charts.monthlyPerformance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'المبيعات (ألف دينار)',
                                data: salesData,
                                backgroundColor: '#4A90E2',
                                borderColor: '#4A90E2',
                                borderWidth: 1
                            },
                            {
                                label: 'الربح (ألف دينار)',
                                data: profitData,
                                backgroundColor: '#50C878',
                                borderColor: '#50C878',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                rtl: true
                            }
                        }
                    }
                });
            }
            
            drawCostDistributionChart(restaurantId) {
                const ctx = document.getElementById('costDistributionChart')?.getContext('2d');
                if (!ctx) return;
                
                let data, labels;
                
                if (restaurantId === 'all') {
                    const costAnalysis = this.dataManager.getCostAnalysis();
                    data = [
                        costAnalysis.totalFoodCost,
                        costAnalysis.totalLaborCost,
                        costAnalysis.totalRent,
                        costAnalysis.totalUtilities,
                        costAnalysis.totalOtherCosts
                    ];
                    labels = ['تكلفة الغذاء', 'تكلفة العمالة', 'الإيجار', 'المرافق', 'تكاليف أخرى'];
                } else {
                    const restaurant = this.dataManager.getRestaurantData(parseInt(restaurantId));
                    if (restaurant) {
                        const annualData = restaurant.annualData;
                        data = [
                            (annualData.foodCost || 0) + (annualData.meatCost || 0) + (annualData.vegetablesCost || 0),
                            annualData.salariesCost || 0,
                            0,
                            (annualData.gasCost || 0) + (annualData.coalCost || 0),
                            (annualData.packagingCost || 0) + (annualData.drinksCost || 0) + 
                            (annualData.maintenanceCost || 0) + (annualData.cleaningCost || 0)
                        ];
                        labels = ['تكلفة الغذاء', 'تكلفة العمالة', 'الإيجار', 'المرافق', 'تكاليف أخرى'];
                    } else {
                        data = [0, 0, 0, 0, 0];
                        labels = ['تكلفة الغذاء', 'تكلفة العمالة', 'الإيجار', 'المرافق', 'تكاليف أخرى'];
                    }
                }
                
                if (this.charts.costDistribution) {
                    this.charts.costDistribution.destroy();
                }
                
                this.charts.costDistribution = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: ['#4A90E2', '#50C878', '#FF6B6B', '#9B59B6', '#F39C12'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                rtl: true
                            }
                        }
                    }
                });
            }
            
            setupDashboardEvents() {
                document.getElementById('refresh-btn')?.addEventListener('click', () => {
                    this.refresh();
                    this.showNotification('تم تحديث البيانات', 'success');
                });
            }
            
            updateStats() {
                const totals = this.dataManager.companyTotals;
                const restCount = document.getElementById('rest-count');
                const totalSales = document.getElementById('total-sales');
                
                if (restCount) {
                    restCount.textContent = totals.totalRestaurants;
                }
                if (totalSales) {
                    totalSales.textContent = Helpers.formatNumber(totals.totalSales);
                }
                
                document.querySelectorAll('.menu-count').forEach((element, index) => {
                    if (index === 0 || index === 2) {
                        element.textContent = totals.totalRestaurants;
                    }
                });
            }
            
            updateCurrentDate() {
                const now = new Date();
                const dateElement = document.getElementById('current-date');
                if (dateElement) {
                    const options = { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric'
                    };
                    dateElement.textContent = now.toLocaleDateString('ar-SA', options).replace(/٢٠٢٥/g, '2025');
                }
            }
            
            refresh() {
                this.updateStats();
                this.navigateTo(this.currentPage);
            }
            
            // التقرير الشهري التفصيلي
            showMonthlyReport() {
                const months = this.dataManager.getAllMonthlyData();
                const monthKeys = Object.keys(months);
                const restaurants = this.dataManager.restaurants;
                
                const content = `
                    <div class="dashboard-header">
                        <h1><i class="fas fa-calendar-alt"></i> التقرير الشهري التفصيلي</h1>
                        <div class="dashboard-actions">
                            <button class="btn btn-primary" onclick="dashboard.exportMonthlyReportExcel()">
                                <i class="fas fa-download"></i> تصدير التقرير (Excel)
                            </button>
                        </div>
                    </div>
                    
                    <div class="filters">
                        <div class="filter-group">
                            <label>اختر الشهر:</label>
                            <select id="report-month-select" onchange="dashboard.filterMonthlyReport()">
                                <option value="all">جميع الشهور</option>
                                ${monthKeys.map(month => `<option value="${month}">${month}</option>`).join('')}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>اختر المطعم:</label>
                            <select id="report-restaurant-select" onchange="dashboard.filterMonthlyReport()">
                                <option value="all">جميع المطاعم</option>
                                ${restaurants.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>مدير المنطقة:</label>
                            <select id="report-area-manager-select" onchange="dashboard.filterMonthlyReport()">
                                <option value="all">جميع المديرين</option>
                                ${[...new Set(restaurants.map(r => r.areaManager))].map(manager => `<option value="${manager}">${manager}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h2><i class="fas fa-table"></i> البيانات الشهرية التفصيلية</h2>
                            <div class="table-controls">
                                <button class="btn btn-secondary" onclick="dashboard.showDetailedMonthlyTable()">
                                    <i class="fas fa-expand"></i> عرض التفاصيل الكاملة
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table" id="monthly-report-table">
                                <thead>
                                    <tr>
                                        <th>الشهر</th>
                                        <th>المطعم</th>
                                        <th>مدير المنطقة</th>
                                        <th>مدير التشغيل</th>
                                        <th>المبيعات</th>
                                        <th>إجمالي التكاليف</th>
                                        <th>صافي الربح</th>
                                        <th>هامش الربح</th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-report-body">
                                    ${this.generateMonthlyReportTable()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="detailed-monthly-table" style="display: none;"></div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
            }
            
            generateMonthlyReportTable() {
                const monthlyData = this.dataManager.getAllMonthlyData();
                let html = '';
                
                Object.entries(monthlyData).forEach(([month, data]) => {
                    data.restaurants.forEach(restaurant => {
                        html += `
                            <tr data-month="${month}" data-restaurant="${restaurant.name}" 
                                data-area-manager="${restaurant.areaManager}" data-ops-manager="${restaurant.operationsManager}">
                                <td>${month}</td>
                                <td>${restaurant.name}</td>
                                <td>${restaurant.areaManager}</td>
                                <td>${restaurant.operationsManager}</td>
                                <td>${Helpers.formatNumber(restaurant.sales)}</td>
                                <td>${Helpers.formatNumber(restaurant.monthData.totalCosts || 0)}</td>
                                <td class="${restaurant.profit >= 0 ? 'positive' : 'negative'}">${Helpers.formatNumber(restaurant.profit)}</td>
                                <td>${restaurant.margin.toFixed(2)}%</td>
                            </tr>
                        `;
                    });
                });
                
                return html;
            }
            
            filterMonthlyReport() {
                const monthSelect = document.getElementById('report-month-select');
                const restaurantSelect = document.getElementById('report-restaurant-select');
                const areaManagerSelect = document.getElementById('report-area-manager-select');
                
                const month = monthSelect?.value || 'all';
                const restaurantId = restaurantSelect?.value || 'all';
                const areaManager = areaManagerSelect?.value || 'all';
                
                const restaurantName = restaurantId !== 'all' ? 
                    this.dataManager.restaurants.find(r => r.id == restaurantId)?.name : 'all';
                
                const rows = document.querySelectorAll('#monthly-report-body tr');
                rows.forEach(row => {
                    const rowMonth = row.dataset.month;
                    const rowRestaurant = row.dataset.restaurant;
                    const rowAreaManager = row.dataset.areaManager;
                    
                    const showMonth = month === 'all' || rowMonth === month;
                    const showRestaurant = restaurantName === 'all' || rowRestaurant === restaurantName;
                    const showAreaManager = areaManager === 'all' || rowAreaManager === areaManager;
                    
                    row.style.display = showMonth && showRestaurant && showAreaManager ? '' : 'none';
                });
            }
            
            showDetailedMonthlyTable() {
                const detailedTable = document.getElementById('detailed-monthly-table');
                const monthlyData = this.dataManager.getAllMonthlyData();
                
                let tableHTML = `
                    <div class="table-container" style="margin-top: 30px;">
                        <div class="table-header">
                            <h2><i class="fas fa-table"></i> التفاصيل الشهرية الكاملة حسب معادلات Excel</h2>
                            <button class="btn btn-secondary" onclick="dashboard.hideDetailedMonthlyTable()">
                                <i class="fas fa-times"></i> إغلاق
                            </button>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>الشهر</th>
                                        <th>المطعم</th>
                                        <th>المبيعات</th>
                                        <th>إجمالي تكلفة المواد</th>
                                        <th>مجمل الربح</th>
                                        <th>مجموع مصاريف التشغيل</th>
                                        <th>الربح قبل العمومية</th>
                                        <th>المصاريف العمومية</th>
                                        <th>صافي الربح</th>
                                        <th>هامش الربح</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                Object.entries(monthlyData).forEach(([month, data]) => {
                    data.restaurants.forEach(restaurant => {
                        const monthData = restaurant.monthData;
                        tableHTML += `
                            <tr>
                                <td>${month}</td>
                                <td>${restaurant.name}</td>
                                <td>${Helpers.formatNumber(monthData.sales)}</td>
                                <td>${Helpers.formatNumber(monthData.totalMaterialCost)}</td>
                                <td>${Helpers.formatNumber(monthData.grossProfit)}</td>
                                <td>${Helpers.formatNumber(monthData.totalOperatingCost)}</td>
                                <td>${Helpers.formatNumber(monthData.profitBeforeGeneral)}</td>
                                <td>${Helpers.formatNumber(monthData.generalExpenses)}</td>
                                <td class="${monthData.netProfit >= 0 ? 'positive' : 'negative'}">${Helpers.formatNumber(monthData.netProfit)}</td>
                                <td>${monthData.profitMargin.toFixed(2)}%</td>
                            </tr>
                        `;
                    });
                });
                
                tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                detailedTable.innerHTML = tableHTML;
                detailedTable.style.display = 'block';
            }
            
            hideDetailedMonthlyTable() {
                const detailedTable = document.getElementById('detailed-monthly-table');
                detailedTable.style.display = 'none';
            }
            
            exportMonthlyReportExcel() {
                const monthlyData = this.dataManager.getAllMonthlyData();
                const wb = XLSX.utils.book_new();
                
                // Create data for Excel sheet
                const excelData = [
                    ['التقرير الشهري التفصيلي - شركة نايف للأغذية'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['الشهر', 'المطعم', 'مدير المنطقة', 'مدير التشغيل', 'المبيعات', 'إجمالي التكاليف', 'صافي الربح', 'هامش الربح']
                ];
                
                Object.entries(monthlyData).forEach(([month, data]) => {
                    data.restaurants.forEach(restaurant => {
                        excelData.push([
                            month,
                            restaurant.name,
                            restaurant.areaManager,
                            restaurant.operationsManager,
                            restaurant.sales,
                            restaurant.monthData.totalCosts || 0,
                            restaurant.profit,
                            restaurant.margin.toFixed(2) + '%'
                        ]);
                    });
                });
                
                // Add detailed cost data sheet
                const detailedData = [
                    ['التفاصيل الشهرية الكاملة حسب معادلات Excel - شركة نايف للأغذية'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['الشهر', 'المطعم', 'المبيعات', 'إجمالي تكلفة المواد', 'مجمل الربح', 'مجموع مصاريف التشغيل', 
                     'الربح قبل العمومية', 'المصاريف العمومية', 'صافي الربح', 'هامش الربح']
                ];
                
                Object.entries(monthlyData).forEach(([month, data]) => {
                    data.restaurants.forEach(restaurant => {
                        const monthData = restaurant.monthData;
                        detailedData.push([
                            month,
                            restaurant.name,
                            monthData.sales,
                            monthData.totalMaterialCost,
                            monthData.grossProfit,
                            monthData.totalOperatingCost,
                            monthData.profitBeforeGeneral,
                            monthData.generalExpenses,
                            monthData.netProfit,
                            monthData.profitMargin.toFixed(2) + '%'
                        ]);
                    });
                });
                
                const ws1 = XLSX.utils.aoa_to_sheet(excelData);
                const ws2 = XLSX.utils.aoa_to_sheet(detailedData);
                
                XLSX.utils.book_append_sheet(wb, ws1, 'التقرير الشهري');
                XLSX.utils.book_append_sheet(wb, ws2, 'التفاصيل الكاملة');
                
                XLSX.writeFile(wb, `التقرير_الشهري_${new Date().toISOString().slice(0, 10)}.xlsx`);
                this.showNotification('تم تصدير التقرير الشهري إلى ملف Excel', 'success');
            }
            
            showRestaurants() {
                const restaurants = this.dataManager.restaurants;
                
                const content = `
                    <div class="dashboard-header">
                        <h1><i class="fas fa-store"></i> إدارة المطاعم (${restaurants.length} مطعم)</h1>
                        <div class="dashboard-actions">
                            <input type="text" id="restaurant-search" placeholder="بحث عن مطعم أو مدير..." 
                                   style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; min-width: 300px;"
                                   oninput="dashboard.filterRestaurants()">
                        </div>
                    </div>
                    
                    <div class="filters">
                        <div class="filter-group">
                            <label>مدير المنطقة:</label>
                            <select id="area-manager-filter" onchange="dashboard.filterRestaurants()">
                                <option value="all">جميع المديرين</option>
                                ${[...new Set(restaurants.map(r => r.areaManager))].map(manager => `<option value="${manager}">${manager}</option>`).join('')}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>مدير التشغيل:</label>
                            <select id="ops-manager-filter" onchange="dashboard.filterRestaurants()">
                                <option value="all">جميع المديرين</option>
                                ${[...new Set(restaurants.map(r => r.operationsManager))].map(manager => `<option value="${manager}">${manager}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="restaurant-grid" id="restaurants-grid">
                        ${restaurants.map(restaurant => {
                            const data = this.dataManager.getRestaurantData(restaurant.id);
                            if (!data) return '';
                            
                            const performance = this.dataManager.getPerformanceLevel(data.totals.profitMargin);
                            
                            return `
                                <div class="restaurant-card" data-name="${restaurant.name}" 
                                     data-area-manager="${restaurant.areaManager}" data-ops-manager="${restaurant.operationsManager}">
                                    <div class="restaurant-card-header">
                                        <h3><i class="fas fa-store"></i> ${restaurant.name}</h3>
                                        <span class="restaurant-id">#${restaurant.id}</span>
                                    </div>
                                    <div class="restaurant-info">
                                        <p><i class="fas fa-user-tie"></i> <strong>مدير المنطقة:</strong> ${restaurant.areaManager}</p>
                                        <p><i class="fas fa-user-cog"></i> <strong>مدير التشغيل:</strong> ${restaurant.operationsManager}</p>
                                    </div>
                                    <div class="restaurant-stats">
                                        <span><i class="fas fa-money-bill-wave"></i> المبيعات: ${Helpers.formatNumber(data.totals.annualSales)} د.ك</span>
                                        <span><i class="fas fa-chart-line"></i> الربح: ${Helpers.formatNumber(data.totals.annualNetProfit)} د.ك</span>
                                        <span><i class="fas fa-percentage"></i> الربحية: ${data.totals.profitMargin.toFixed(2)}%</span>
                                    </div>
                                    <div class="restaurant-performance">
                                        <div class="performance-bar">
                                            <div class="performance-fill" style="width: ${Math.min(data.totals.profitMargin * 3, 100)}%; 
                                                 background: ${performance.color}">
                                            </div>
                                        </div>
                                        <span class="performance-text">${performance.level}</span>
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn-icon" onclick="dashboard.showRestaurantDetails(${restaurant.id})">
                                            <i class="fas fa-eye"></i> عرض التفاصيل
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
            }
            
            filterRestaurants() {
                const searchInput = document.getElementById('restaurant-search');
                const areaManagerFilter = document.getElementById('area-manager-filter');
                const opsManagerFilter = document.getElementById('ops-manager-filter');
                
                const searchTerm = searchInput?.value.toLowerCase() || '';
                const areaManagerValue = areaManagerFilter?.value || 'all';
                const opsManagerValue = opsManagerFilter?.value || 'all';
                
                document.querySelectorAll('.restaurant-card').forEach(card => {
                    const name = card.dataset.name.toLowerCase();
                    const areaManager = card.dataset.areaManager;
                    const opsManager = card.dataset.opsManager;
                    
                    const matchesSearch = name.includes(searchTerm) || 
                                         areaManager.toLowerCase().includes(searchTerm) ||
                                         opsManager.toLowerCase().includes(searchTerm);
                    const matchesAreaManager = areaManagerValue === 'all' || areaManager === areaManagerValue;
                    const matchesOpsManager = opsManagerValue === 'all' || opsManager === opsManagerValue;
                    
                    card.style.display = matchesSearch && matchesAreaManager && matchesOpsManager ? 
                        'block' : 'none';
                });
            }
            
            showManagers() {
                const managers = this.dataManager.getManagersData();
                
                const content = `
                    <div class="dashboard-header">
                        <h1><i class="fas fa-user-tie"></i> تقرير أداء المديرين</h1>
                        <div class="dashboard-actions">
                            <button class="btn btn-primary" onclick="dashboard.exportManagersReportExcel()">
                                <i class="fas fa-download"></i> تصدير التقرير (Excel)
                            </button>
                        </div>
                    </div>
                    
                    <div class="manager-grid" id="managers-grid">
                        ${Object.values(managers).map((manager, index) => {
                            return `
                                <div class="manager-card">
                                    <div class="manager-card-header">
                                        <h3><i class="fas fa-user-tie"></i> ${manager.name}</h3>
                                        <span class="manager-type ${manager.type === 'مدير منطقة' ? 'area-manager' : 'ops-manager'}">
                                            ${manager.type}
                                        </span>
                                    </div>
                                    <div class="manager-info">
                                        <p><i class="fas fa-store"></i> <strong>عدد المطاعم:</strong> ${manager.restaurantCount}</p>
                                        <p><i class="fas fa-list"></i> <strong>المطاعم:</strong> ${manager.restaurants.slice(0, 3).join('، ')}${manager.restaurants.length > 3 ? '...' : ''}</p>
                                    </div>
                                    <div class="manager-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">المبيعات</span>
                                            <span class="stat-value">${Helpers.formatNumber(manager.totalSales)}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">الربح</span>
                                            <span class="stat-value ${manager.totalProfit >= 0 ? 'positive' : 'negative'}">
                                                ${Helpers.formatNumber(manager.totalProfit)}
                                            </span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">الربحية</span>
                                            <span class="stat-value">${manager.profitMargin.toFixed(2)}%</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
            }
            
            // تحليل التكاليف التفصيلي
            showCostAnalysis() {
                const managers = this.dataManager.getUniqueManagers();
                
                const content = `
                    <div class="dashboard-header">
                        <h1><i class="fas fa-money-bill-wave"></i> تحليل التكاليف التفصيلي حسب معادلات Excel</h1>
                        <div class="dashboard-actions">
                            <button class="btn btn-primary" onclick="dashboard.exportCostAnalysisExcel()">
                                <i class="fas fa-download"></i> تصدير التحليل (Excel)
                            </button>
                        </div>
                    </div>
                    
                    <div class="filters">
                        <div class="filter-group">
                            <label>اختر المطعم:</label>
                            <select id="cost-restaurant-filter" onchange="dashboard.filterCostAnalysis()">
                                <option value="all">جميع المطاعم</option>
                                ${this.dataManager.restaurants.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>مدير المنطقة:</label>
                            <select id="cost-area-manager-filter" onchange="dashboard.filterCostAnalysis()">
                                <option value="all">جميع المديرين</option>
                                ${managers.areaManagers.map(manager => `<option value="${manager}">${manager}</option>`).join('')}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>مدير التشغيل:</label>
                            <select id="cost-ops-manager-filter" onchange="dashboard.filterCostAnalysis()">
                                <option value="all">جميع المديرين</option>
                                ${managers.operationsManagers.map(manager => `<option value="${manager}">${manager}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div id="cost-analysis-results">
                        ${this.generateCostAnalysisTable('all', 'all', 'all')}
                    </div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
            }
            
            generateCostAnalysisTable(restaurantId, areaManager, opsManager) {
                let costDetails = this.dataManager.getAllCostDetails();
                
                // Apply filters
                if (restaurantId !== 'all') {
                    const restaurant = this.dataManager.getRestaurantData(parseInt(restaurantId));
                    costDetails = costDetails.filter(c => c.name === restaurant?.name);
                }
                
                if (areaManager !== 'all') {
                    costDetails = costDetails.filter(c => c.areaManager === areaManager);
                }
                
                if (opsManager !== 'all') {
                    costDetails = costDetails.filter(c => c.operationsManager === opsManager);
                }
                
                let tableHTML = `
                    <div class="table-container">
                        <div class="table-header">
                            <h2><i class="fas fa-table"></i> تحليل التكاليف السنوية</h2>
                            <div class="table-controls">
                                <button class="btn btn-secondary" onclick="dashboard.showDetailedCostAnalysis()">
                                    <i class="fas fa-expand"></i> عرض التفاصيل الكاملة
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>المطعم</th>
                                        <th>مدير المنطقة</th>
                                        <th>مدير التشغيل</th>
                                        <th>المبيعات</th>
                                        <th>إجمالي تكلفة المواد</th>
                                        <th>مجمل الربح</th>
                                        <th>مجموع مصاريف التشغيل</th>
                                        <th>الربح قبل العمومية</th>
                                        <th>المصاريف العمومية</th>
                                        <th>صافي الربح</th>
                                        <th>هامش الربح</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                costDetails.forEach(cost => {
                    const restaurant = this.dataManager.restaurants.find(r => r.name === cost.name);
                    if (!restaurant) return;
                    
                    const totals = restaurant.totals;
                    
                    tableHTML += `
                        <tr>
                            <td>${cost.name}</td>
                            <td>${cost.areaManager}</td>
                            <td>${cost.operationsManager}</td>
                            <td>${Helpers.formatNumber(totals.annualSales)}</td>
                            <td>${Helpers.formatNumber(cost.totalMaterialCost)}</td>
                            <td>${Helpers.formatNumber(totals.annualGrossProfit)}</td>
                            <td>${Helpers.formatNumber(cost.totalOperatingCost)}</td>
                            <td>${Helpers.formatNumber(totals.annualProfitBeforeGeneral)}</td>
                            <td>${Helpers.formatNumber(cost.generalExpenses)}</td>
                            <td class="${totals.annualNetProfit >= 0 ? 'positive' : 'negative'}">${Helpers.formatNumber(totals.annualNetProfit)}</td>
                            <td>${totals.profitMargin.toFixed(2)}%</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                return tableHTML;
            }
            
            showDetailedCostAnalysis() {
                const detailedTable = document.getElementById('detailed-monthly-table');
                const costDetails = this.dataManager.getAllCostDetails();
                
                let tableHTML = `
                    <div class="table-container" style="margin-top: 30px;">
                        <div class="table-header">
                            <h2><i class="fas fa-table"></i> تحليل التكاليف التفصيلي الكامل</h2>
                            <button class="btn btn-secondary" onclick="dashboard.hideDetailedMonthlyTable()">
                                <i class="fas fa-times"></i> إغلاق
                            </button>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>المطعم</th>
                                        <th>مدير المنطقة</th>
                                        <th>مدير التشغيل</th>
                                        <th>تكلفة غذاء مخازن</th>
                                        <th>تكلفة لحوم</th>
                                        <th>تكلفة مرطبات</th>
                                        <th>تكلفة تعبئة</th>
                                        <th>تكلفة خبز</th>
                                        <th>تكلفة بهارات</th>
                                        <th>تكلفة فحم</th>
                                        <th>تكلفة خضار</th>
                                        <th>تكلفة غاز</th>
                                        <th>رواتب وأجور</th>
                                        <th>أعمال إضافية</th>
                                        <th>توالف مواد</th>
                                        <th>صيانة</th>
                                        <th>نظافة</th>
                                        <th>لوازم عمال</th>
                                        <th>لوازم مطاعم</th>
                                        <th>قرطاسية</th>
                                        <th>وجبات عمال</th>
                                        <th>مصاريف أخرى</th>
                                        <th>إجمالي التكاليف</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                costDetails.forEach(cost => {
                    tableHTML += `
                        <tr>
                            <td>${cost.name}</td>
                            <td>${cost.areaManager}</td>
                            <td>${cost.operationsManager}</td>
                            <td>${Helpers.formatNumber(cost.foodCost)}</td>
                            <td>${Helpers.formatNumber(cost.meatCost)}</td>
                            <td>${Helpers.formatNumber(cost.drinksCost)}</td>
                            <td>${Helpers.formatNumber(cost.packagingCost)}</td>
                            <td>${Helpers.formatNumber(cost.breadCost)}</td>
                            <td>${Helpers.formatNumber(cost.spicesCost)}</td>
                            <td>${Helpers.formatNumber(cost.coalCost)}</td>
                            <td>${Helpers.formatNumber(cost.vegetablesCost)}</td>
                            <td>${Helpers.formatNumber(cost.gasCost)}</td>
                            <td>${Helpers.formatNumber(cost.salariesCost)}</td>
                            <td>${Helpers.formatNumber(cost.extraWorkCost)}</td>
                            <td>${Helpers.formatNumber(cost.wasteCost)}</td>
                            <td>${Helpers.formatNumber(cost.maintenanceCost)}</td>
                            <td>${Helpers.formatNumber(cost.cleaningCost)}</td>
                            <td>${Helpers.formatNumber(cost.workersSuppliesCost)}</td>
                            <td>${Helpers.formatNumber(cost.restaurantSuppliesCost)}</td>
                            <td>${Helpers.formatNumber(cost.stationeryCost)}</td>
                            <td>${Helpers.formatNumber(cost.workersMealsCost)}</td>
                            <td>${Helpers.formatNumber(cost.otherOperatingCost)}</td>
                            <td><strong>${Helpers.formatNumber(
                                cost.totalMaterialCost + 
                                cost.totalOperatingCost + 
                                cost.generalExpenses
                            )}</strong></td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                detailedTable.innerHTML = tableHTML;
                detailedTable.style.display = 'block';
            }
            
            filterCostAnalysis() {
                const restaurantFilter = document.getElementById('cost-restaurant-filter');
                const areaManagerFilter = document.getElementById('cost-area-manager-filter');
                const opsManagerFilter = document.getElementById('cost-ops-manager-filter');
                
                const restaurantId = restaurantFilter?.value || 'all';
                const areaManager = areaManagerFilter?.value || 'all';
                const opsManager = opsManagerFilter?.value || 'all';
                
                const resultsDiv = document.getElementById('cost-analysis-results');
                resultsDiv.innerHTML = this.generateCostAnalysisTable(restaurantId, areaManager, opsManager);
            }
            
            exportCostAnalysisExcel() {
                const costDetails = this.dataManager.getAllCostDetails();
                const wb = XLSX.utils.book_new();
                
                const excelData = [
                    ['تحليل التكاليف التفصيلي - شركة نايف للأغذية'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['المطعم', 'مدير المنطقة', 'مدير التشغيل', 'المبيعات السنوية', 'إجمالي تكلفة المواد', 
                     'مجمل الربح', 'مجموع مصاريف التشغيل', 'الربح قبل العمومية', 'المصاريف العمومية', 
                     'صافي الربح', 'هامش الربح']
                ];
                
                costDetails.forEach(cost => {
                    const restaurant = this.dataManager.restaurants.find(r => r.name === cost.name);
                    if (!restaurant) return;
                    
                    const totals = restaurant.totals;
                    
                    excelData.push([
                        cost.name,
                        cost.areaManager,
                        cost.operationsManager,
                        totals.annualSales,
                        cost.totalMaterialCost,
                        totals.annualGrossProfit,
                        cost.totalOperatingCost,
                        totals.annualProfitBeforeGeneral,
                        cost.generalExpenses,
                        totals.annualNetProfit,
                        totals.profitMargin.toFixed(2) + '%'
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, 'تحليل التكاليف');
                
                XLSX.writeFile(wb, `تحليل_التكاليف_${new Date().toISOString().slice(0, 10)}.xlsx`);
                this.showNotification('تم تصدير تحليل التكاليف إلى ملف Excel', 'success');
            }
            
            // تحليل الربحية المتقدم
            showProfitAnalysis() {
                const managers = this.dataManager.getUniqueManagers();
                
                const content = `
                    <div class="dashboard-header">
                        <h1><i class="fas fa-chart-line"></i> تحليل الربحية المتقدم حسب معادلات Excel</h1>
                        <div class="dashboard-actions">
                            <button class="btn btn-primary" onclick="dashboard.exportProfitAnalysisExcel()">
                                <i class="fas fa-download"></i> تصدير التحليل (Excel)
                            </button>
                        </div>
                    </div>
                    
                    <div class="filters">
                        <div class="filter-group">
                            <label>اختر المطعم:</label>
                            <select id="profit-restaurant-filter" onchange="dashboard.filterProfitAnalysis()">
                                <option value="all">جميع المطاعم</option>
                                ${this.dataManager.restaurants.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>مدير المنطقة:</label>
                            <select id="profit-area-manager-filter" onchange="dashboard.filterProfitAnalysis()">
                                <option value="all">جميع المديرين</option>
                                ${managers.areaManagers.map(manager => `<option value="${manager}">${manager}</option>`).join('')}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>مدير التشغيل:</label>
                            <select id="profit-ops-manager-filter" onchange="dashboard.filterProfitAnalysis()">
                                <option value="all">جميع المديرين</option>
                                ${managers.operationsManagers.map(manager => `<option value="${manager}">${manager}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div id="profit-analysis-results">
                        ${this.generateProfitAnalysisTable('all', 'all', 'all')}
                    </div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
            }
            
            generateProfitAnalysisTable(restaurantId, areaManager, opsManager) {
                let restaurants = this.dataManager.restaurants.map(rest => {
                    const data = this.dataManager.getRestaurantData(rest.id);
                    if (!data) return null;
                    
                    return {
                        id: rest.id,
                        name: rest.name,
                        areaManager: rest.areaManager,
                        operationsManager: rest.operationsManager,
                        annualSales: data.totals.annualSales,
                        annualTotalMaterialCost: data.totals.annualTotalMaterialCost,
                        annualGrossProfit: data.totals.annualGrossProfit,
                        annualTotalOperatingCost: data.totals.annualTotalOperatingCost,
                        annualProfitBeforeGeneral: data.totals.annualProfitBeforeGeneral,
                        annualGeneralExpenses: data.totals.annualGeneralExpenses,
                        annualNetProfit: data.totals.annualNetProfit,
                        profitMargin: data.totals.profitMargin
                    };
                }).filter(Boolean);
                
                // Apply filters
                if (restaurantId !== 'all') {
                    const restaurant = this.dataManager.getRestaurantData(parseInt(restaurantId));
                    restaurants = restaurants.filter(r => r.id === parseInt(restaurantId));
                }
                
                if (areaManager !== 'all') {
                    restaurants = restaurants.filter(r => r.areaManager === areaManager);
                }
                
                if (opsManager !== 'all') {
                    restaurants = restaurants.filter(r => r.operationsManager === opsManager);
                }
                
                const sortedRestaurants = restaurants.sort((a, b) => b.profitMargin - a.profitMargin);
                
                let tableHTML = `
                    <div class="table-container">
                        <div class="table-header">
                            <h2><i class="fas fa-table"></i> تحليل ربحية المطاعم حسب معادلات Excel</h2>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>المطعم</th>
                                        <th>مدير المنطقة</th>
                                        <th>مدير التشغيل</th>
                                        <th>المبيعات</th>
                                        <th>تكلفة المواد</th>
                                        <th>مجمل الربح</th>
                                        <th>مصاريف التشغيل</th>
                                        <th>ربح قبل العمومية</th>
                                        <th>مصاريف عمومية</th>
                                        <th>صافي الربح</th>
                                        <th>هامش الربح</th>
                                        <th>مستوى الأداء</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                sortedRestaurants.forEach((restaurant, index) => {
                    const performance = this.dataManager.getPerformanceLevel(restaurant.profitMargin);
                    tableHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${restaurant.name}</td>
                            <td>${restaurant.areaManager}</td>
                            <td>${restaurant.operationsManager}</td>
                            <td>${Helpers.formatNumber(restaurant.annualSales)}</td>
                            <td>${Helpers.formatNumber(restaurant.annualTotalMaterialCost)}</td>
                            <td>${Helpers.formatNumber(restaurant.annualGrossProfit)}</td>
                            <td>${Helpers.formatNumber(restaurant.annualTotalOperatingCost)}</td>
                            <td>${Helpers.formatNumber(restaurant.annualProfitBeforeGeneral)}</td>
                            <td>${Helpers.formatNumber(restaurant.annualGeneralExpenses)}</td>
                            <td class="${restaurant.annualNetProfit >= 0 ? 'positive' : 'negative'}">
                                ${Helpers.formatNumber(restaurant.annualNetProfit)}
                            </td>
                            <td><span class="badge ${performance.class}">${restaurant.profitMargin.toFixed(2)}%</span></td>
                            <td><span class="performance-label">${performance.level}</span></td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                return tableHTML;
            }
            
            filterProfitAnalysis() {
                const restaurantFilter = document.getElementById('profit-restaurant-filter');
                const areaManagerFilter = document.getElementById('profit-area-manager-filter');
                const opsManagerFilter = document.getElementById('profit-ops-manager-filter');
                
                const restaurantId = restaurantFilter?.value || 'all';
                const areaManager = areaManagerFilter?.value || 'all';
                const opsManager = opsManagerFilter?.value || 'all';
                
                const resultsDiv = document.getElementById('profit-analysis-results');
                resultsDiv.innerHTML = this.generateProfitAnalysisTable(restaurantId, areaManager, opsManager);
            }
            
            exportProfitAnalysisExcel() {
                const restaurants = this.dataManager.restaurants.map(rest => {
                    const data = this.dataManager.getRestaurantData(rest.id);
                    return data;
                }).filter(Boolean).sort((a, b) => b.totals.profitMargin - a.totals.profitMargin);
                
                const wb = XLSX.utils.book_new();
                
                const excelData = [
                    ['تحليل الربحية المتقدم حسب معادلات Excel - شركة نايف للأغذية'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['#', 'المطعم', 'مدير المنطقة', 'مدير التشغيل', 'المبيعات السنوية', 'تكلفة المواد', 
                     'مجمل الربح', 'مصاريف التشغيل', 'ربح قبل العمومية', 'مصاريف عمومية', 'صافي الربح', 
                     'هامش الربح', 'مستوى الأداء']
                ];
                
                restaurants.forEach((rest, index) => {
                    const performance = this.dataManager.getPerformanceLevel(rest.totals.profitMargin);
                    excelData.push([
                        index + 1,
                        rest.name,
                        rest.areaManager,
                        rest.operationsManager,
                        rest.totals.annualSales,
                        rest.totals.annualTotalMaterialCost,
                        rest.totals.annualGrossProfit,
                        rest.totals.annualTotalOperatingCost,
                        rest.totals.annualProfitBeforeGeneral,
                        rest.totals.annualGeneralExpenses,
                        rest.totals.annualNetProfit,
                        rest.totals.profitMargin.toFixed(2) + '%',
                        performance.level
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, 'تحليل الربحية');
                
                XLSX.writeFile(wb, `تحليل_الربحية_${new Date().toISOString().slice(0, 10)}.xlsx`);
                this.showNotification('تم تصدير تحليل الربحية إلى ملف Excel', 'success');
            }
            
            // شاشة الخطة المعدلة حسب المطلوب
            showPlanning() {
                if (this.dataManager.restaurants.length === 0) {
                    this.showNotification('لا توجد بيانات مطاعم. يرجى تحميل ملف Excel أولاً.', 'error');
                    this.navigateTo('dashboard');
                    return;
                }
                
                const percentages = this.dataManager.getPlanningPercentages();
                const sampleRestaurant = this.dataManager.restaurants[0];
                const novemberData = this.dataManager.getNovemberData(sampleRestaurant);
                
                const content = `
                    <div class="dashboard-header">
                        <h1><i class="fas fa-chart-pie"></i> خطة تحسين الأداء 2026 (حساب نسبي حسب نوفمبر)</h1>
                        <div class="dashboard-actions">
                            <button class="btn btn-primary" onclick="dashboard.savePlanningPercentages()">
                                <i class="fas fa-save"></i> حفظ النسب
                            </button>
                            <button class="btn btn-secondary" onclick="dashboard.generatePlanningTemplate2026()">
                                <i class="fas fa-download"></i> إنشاء خطة 2026
                            </button>
                        </div>
                    </div>
                    
                    <div class="planning-percentages-container">
                        <div class="percentage-controls">
                            <h3><i class="fas fa-sliders-h"></i> تعيين نسب الزيادة/النقصان</h3>
                            <p style="margin-bottom: 20px; color: #666; font-size: 0.95rem;">
                                يتم حساب القيم المستهدفة لسنة 2026 بناءً على:
                                <br>1. بيانات شهر نوفمبر 2025 كأساس
                                <br>2. النسب المحددة لكل حساب
                                <br>3. تعديل عدد أيام الشهر (30 يوم لشهر نوفمبر)
                                <br>4. صيغة الحساب: (قيمة نوفمبر / 30 × عدد أيام الشهر الهدف) × (1 + النسبة/100)
                            </p>
                            
                            <div class="percentage-group">
                                <h4><i class="fas fa-money-bill-wave"></i> المبيعات</h4>
                                <div class="percentage-item">
                                    <label>نسبة زيادة المبيعات:</label>
                                    <div class="percentage-input-group">
                                        <input type="number" id="sales-percentage" value="${percentages.salesPercentage}" 
                                               min="-100" max="100" step="0.5">
                                        <span>%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="account-group-header">
                                <i class="fas fa-shopping-cart"></i> تكاليف المواد
                            </div>
                            <div class="percentage-group">
                                ${this.generateCostPercentageControls(percentages)}
                            </div>
                            
                            <div class="account-group-header">
                                <i class="fas fa-tools"></i> مصاريف التشغيل
                            </div>
                            <div class="percentage-group">
                                ${this.generateExpensePercentageControls(percentages)}
                            </div>
                            
                            <div class="account-group-header">
                                <i class="fas fa-file-invoice-dollar"></i> حسابات أخرى
                            </div>
                            <div class="percentage-group">
                                <div class="percentage-item">
                                    <label>فرق الجرد:</label>
                                    <div class="percentage-input-group">
                                        <input type="number" id="inventory-difference-percentage" value="${percentages.inventoryDifferencePercentage}" 
                                               min="-100" max="100" step="0.5">
                                        <span>%</span>
                                    </div>
                                </div>
                                <div class="percentage-item">
                                    <label>المصاريف العمومية:</label>
                                    <div class="percentage-input-group">
                                        <input type="number" id="general-expenses-percentage" value="${percentages.generalExpensesPercentage}" 
                                               min="-100" max="100" step="0.5">
                                        <span>%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="percentage-preview">
                            <h3><i class="fas fa-eye"></i> معاينة الحسابات</h3>
                            <p style="margin-bottom: 20px; color: #666; font-size: 0.95rem;">
                                مثال تطبيقي بناءً على بيانات نوفمبر 2025 لأحد المطاعم:
                            </p>
                            
                            <div class="preview-summary">
                                <div class="preview-item">
                                    <span>المبيعات نوفمبر 2025:</span>
                                    <span class="value">${Helpers.formatNumber(novemberData.sales)} د.ك</span>
                                </div>
                                <div class="preview-item">
                                    <span>نسبة الزيادة المحددة:</span>
                                    <span class="value">${percentages.salesPercentage}%</span>
                                </div>
                            </div>
                            
                            <div class="preview-calculation">
                                <strong>مثال حسابي لشهر يناير 2026:</strong>
                                <br>المعادلة: (${Helpers.formatNumber(novemberData.sales)} ÷ 30 × 31) × (1 + ${percentages.salesPercentage}%)
                                <br>الحساب: (${Helpers.formatNumber(novemberData.sales / 30)} × 31) × 1.${percentages.salesPercentage}
                                <br>النتيجة: ${Helpers.formatNumber(this.dataManager.calculateMonthValue(novemberData.sales, percentages.salesPercentage, 31))} د.ك
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="margin-bottom: 10px; color: var(--dark-color);">
                                    <i class="fas fa-info-circle"></i> معلومات مهمة
                                </h4>
                                <ul style="color: #666; font-size: 0.9rem; padding-right: 20px;">
                                    <li>يتم أخذ بيانات شهر نوفمبر 2025 كأساس للحسابات</li>
                                    <li>يتم تعديل القيم حسب عدد أيام كل شهر (يناير 31 يوم، فبراير 28 يوم، إلخ)</li>
                                    <li>يتم تطبيق النسبة المحددة لكل حساب على حدة</li>
                                    <li>يتم حساب القيم المحسوبة (المجملات) تلقائياً حسب معادلات Excel</li>
                                    <li>سيتم إنشاء ملف Excel يحتوي على شيت لكل مطعم (31 صف لكل مطعم)</li>
                                </ul>
                            </div>
                            
                            <button class="btn btn-primary" onclick="dashboard.generatePlanningTemplate2026()" 
                                    style="margin-top: 20px; width: 100%; padding: 12px;">
                                <i class="fas fa-file-excel"></i> إنشاء ملف خطة 2026
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
            }
            
            generateCostPercentageControls(percentages) {
                return `
                    <div class="percentage-item">
                        <label>تكلفة المواد الغذائية:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="food-cost-percentage" value="${percentages.foodCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>تكلفة اللحوم:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="meat-cost-percentage" value="${percentages.meatCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>تكلفة المرطبات:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="drinks-cost-percentage" value="${percentages.drinksCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>تكلفة التعبئة:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="packaging-cost-percentage" value="${percentages.packagingCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>تكلفة الخبز:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="bread-cost-percentage" value="${percentages.breadCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>تكلفة البهارات:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="spices-cost-percentage" value="${percentages.spicesCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>تكلفة الفحم:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="coal-cost-percentage" value="${percentages.coalCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>تكلفة الخضار:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="vegetables-cost-percentage" value="${percentages.vegetablesCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>تكلفة الغاز:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="gas-cost-percentage" value="${percentages.gasCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                `;
            }
            
            generateExpensePercentageControls(percentages) {
                return `
                    <div class="percentage-item">
                        <label>رواتب وأجور:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="salaries-cost-percentage" value="${percentages.salariesCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>أعمال إضافية:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="extra-work-cost-percentage" value="${percentages.extraWorkCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>توالف المواد:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="waste-cost-percentage" value="${percentages.wasteCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>الصيانة:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="maintenance-cost-percentage" value="${percentages.maintenanceCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>النظافة:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="cleaning-cost-percentage" value="${percentages.cleaningCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>لوازم العمال:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="workers-supplies-cost-percentage" value="${percentages.workersSuppliesCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>لوازم المطاعم:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="restaurant-supplies-cost-percentage" value="${percentages.restaurantSuppliesCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>قرطاسية ومطبوعات:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="stationery-cost-percentage" value="${percentages.stationeryCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>وجبات العاملين:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="workers-meals-cost-percentage" value="${percentages.workersMealsCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                    <div class="percentage-item">
                        <label>مصاريف تشغيل أخرى:</label>
                        <div class="percentage-input-group">
                            <input type="number" id="other-operating-cost-percentage" value="${percentages.otherOperatingCostPercentage}" 
                                   min="-100" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    </div>
                `;
            }
            
            savePlanningPercentages() {
                const percentages = {
                    salesPercentage: parseFloat(document.getElementById('sales-percentage').value) || 0,
                    foodCostPercentage: parseFloat(document.getElementById('food-cost-percentage').value) || 0,
                    meatCostPercentage: parseFloat(document.getElementById('meat-cost-percentage').value) || 0,
                    drinksCostPercentage: parseFloat(document.getElementById('drinks-cost-percentage').value) || 0,
                    packagingCostPercentage: parseFloat(document.getElementById('packaging-cost-percentage').value) || 0,
                    breadCostPercentage: parseFloat(document.getElementById('bread-cost-percentage').value) || 0,
                    spicesCostPercentage: parseFloat(document.getElementById('spices-cost-percentage').value) || 0,
                    coalCostPercentage: parseFloat(document.getElementById('coal-cost-percentage').value) || 0,
                    vegetablesCostPercentage: parseFloat(document.getElementById('vegetables-cost-percentage').value) || 0,
                    gasCostPercentage: parseFloat(document.getElementById('gas-cost-percentage').value) || 0,
                    salariesCostPercentage: parseFloat(document.getElementById('salaries-cost-percentage').value) || 0,
                    extraWorkCostPercentage: parseFloat(document.getElementById('extra-work-cost-percentage').value) || 0,
                    wasteCostPercentage: parseFloat(document.getElementById('waste-cost-percentage').value) || 0,
                    maintenanceCostPercentage: parseFloat(document.getElementById('maintenance-cost-percentage').value) || 0,
                    cleaningCostPercentage: parseFloat(document.getElementById('cleaning-cost-percentage').value) || 0,
                    workersSuppliesCostPercentage: parseFloat(document.getElementById('workers-supplies-cost-percentage').value) || 0,
                    restaurantSuppliesCostPercentage: parseFloat(document.getElementById('restaurant-supplies-cost-percentage').value) || 0,
                    stationeryCostPercentage: parseFloat(document.getElementById('stationery-cost-percentage').value) || 0,
                    workersMealsCostPercentage: parseFloat(document.getElementById('workers-meals-cost-percentage').value) || 0,
                    otherOperatingCostPercentage: parseFloat(document.getElementById('other-operating-cost-percentage').value) || 0,
                    inventoryDifferencePercentage: parseFloat(document.getElementById('inventory-difference-percentage').value) || 0,
                    generalExpensesPercentage: parseFloat(document.getElementById('general-expenses-percentage').value) || 0
                };
                
                this.dataManager.savePlanningPercentages(percentages);
                this.showNotification('تم حفظ النسب بنجاح', 'success');
            }
            
            generatePlanningTemplate2026() {
                try {
                    if (this.dataManager.restaurants.length === 0) {
                        this.showNotification('لا توجد بيانات مطاعم. يرجى تحميل ملف Excel أولاً.', 'error');
                        return;
                    }
                    
                    this.showNotification('جار إنشاء ملف خطة 2026...', 'info');
                    
                    // حفظ النسب أولاً
                    this.savePlanningPercentages();
                    
                    // إنشاء ملف التخطيط
                    const wb = this.dataManager.generatePlanningTemplate2026();
                    
                    // حفظ الملف
                    XLSX.writeFile(wb, `خطة_2026_شركة_نايف_للأغذية_${new Date().toISOString().slice(0, 10)}.xlsx`);
                    
                    this.showNotification('تم إنشاء ملف خطة 2026 بنجاح!', 'success');
                    
                } catch (error) {
                    console.error('Error generating planning template:', error);
                    this.showNotification(`خطأ في إنشاء الملف: ${error.message}`, 'error');
                }
            }
            
            // مقارنة أداء المطاعم
            showComparison() {
                const restaurants = this.dataManager.restaurants;
                
                const content = `
                    <div class="dashboard-header">
                        <h1><i class="fas fa-chart-bar"></i> مقارنة أداء المطاعم</h1>
                        <div class="dashboard-actions">
                            <button class="btn btn-primary" onclick="dashboard.exportComparisonExcel()">
                                <i class="fas fa-download"></i> تصدير المقارنة (Excel)
                            </button>
                        </div>
                    </div>
                    
                    <div class="comparison-controls">
                        <div class="filter-group">
                            <label>اختر المطاعم للمقارنة (2-5 مطاعم):</label>
                            <select id="compare-restaurants" multiple style="height: 200px; width: 100%;">
                                ${restaurants.map(r => `<option value="${r.id}">${r.name} - ${r.areaManager}</option>`).join('')}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>المقارنة حسب:</label>
                            <select id="compare-metric">
                                <option value="sales">المبيعات</option>
                                <option value="profit">الربح</option>
                                <option value="margin">هامش الربح</option>
                                <option value="all">جميع المؤشرات</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="dashboard.generateComparison()" 
                            style="margin: 20px 0; padding: 12px 30px;">
                        <i class="fas fa-chart-bar"></i> إنشاء المقارنة
                    </button>
                    
                    <div id="comparison-results"></div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
            }
            
            generateComparison() {
                const select = document.getElementById('compare-restaurants');
                const selectedOptions = Array.from(select.selectedOptions);
                const metric = document.getElementById('compare-metric').value;
                
                if (selectedOptions.length < 2 || selectedOptions.length > 5) {
                    this.showNotification('يرجى اختيار بين 2 إلى 5 مطاعم للمقارنة', 'error');
                    return;
                }
                
                const restaurants = selectedOptions.map(option => {
                    const id = parseInt(option.value);
                    return this.dataManager.getRestaurantData(id);
                }).filter(Boolean);
                
                let tableHTML = `
                    <div class="table-container">
                        <div class="table-header">
                            <h2><i class="fas fa-table"></i> نتائج المقارنة حسب معادلات Excel</h2>
                            <div class="table-controls">
                                <button class="btn btn-secondary" onclick="dashboard.exportComparisonExcel()">
                                    <i class="fas fa-download"></i> تصدير المقارنة
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>المطعم</th>
                                        <th>مدير المنطقة</th>
                                        <th>مدير التشغيل</th>
                                        <th>المبيعات السنوية</th>
                                        <th>تكلفة المواد</th>
                                        <th>مجمل الربح</th>
                                        <th>مصاريف التشغيل</th>
                                        <th>صافي الربح</th>
                                        <th>هامش الربح</th>
                                        <th>مستوى الأداء</th>
                                        <th>الترتيب حسب الربحية</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                restaurants.forEach((rest, index) => {
                    const performance = this.dataManager.getPerformanceLevel(rest.totals.profitMargin);
                    tableHTML += `
                        <tr>
                            <td><strong>${rest.name}</strong></td>
                            <td>${rest.areaManager}</td>
                            <td>${rest.operationsManager}</td>
                            <td>${Helpers.formatCurrency(rest.totals.annualSales)}</td>
                            <td>${Helpers.formatCurrency(rest.totals.annualTotalMaterialCost)}</td>
                            <td>${Helpers.formatCurrency(rest.totals.annualGrossProfit)}</td>
                            <td>${Helpers.formatCurrency(rest.totals.annualTotalOperatingCost)}</td>
                            <td class="${rest.totals.annualNetProfit >= 0 ? 'positive' : 'negative'}">
                                ${Helpers.formatCurrency(rest.totals.annualNetProfit)}
                            </td>
                            <td><span class="badge ${performance.class}">${rest.totals.profitMargin.toFixed(2)}%</span></td>
                            <td>${performance.level}</td>
                            <td>${index + 1}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h2><i class="fas fa-chart-bar"></i> مخطط المقارنة</h2>
                            <select id="comparison-chart-type" onchange="dashboard.updateComparisonChart()">
                                <option value="bar">مخطط أعمدة</option>
                                <option value="radar">مخطط رادار</option>
                            </select>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                `;
                
                document.getElementById('comparison-results').innerHTML = tableHTML;
                
                setTimeout(() => {
                    this.drawComparisonChart(restaurants, metric);
                }, 100);
            }
            
            drawComparisonChart(restaurants, metric) {
                const ctx = document.getElementById('comparisonChart')?.getContext('2d');
                if (!ctx) return;
                
                const labels = restaurants.map(r => r.name);
                const colors = ['#4A90E2', '#50C878', '#FF6B6B', '#9B59B6', '#F39C12'];
                
                let datasets = [];
                let chartType = document.getElementById('comparison-chart-type')?.value || 'bar';
                
                if (metric === 'all' || chartType === 'radar') {
                    datasets = [
                        {
                            label: 'المبيعات السنوية (ألف دينار)',
                            data: restaurants.map(r => r.totals.annualSales / 1000),
                            backgroundColor: 'rgba(74, 144, 226, 0.2)',
                            borderColor: '#4A90E2',
                            borderWidth: 2
                        },
                        {
                            label: 'صافي الربح (ألف دينار)',
                            data: restaurants.map(r => r.totals.annualNetProfit / 1000),
                            backgroundColor: 'rgba(80, 200, 120, 0.2)',
                            borderColor: '#50C878',
                            borderWidth: 2
                        },
                        {
                            label: 'هامش الربح (%)',
                            data: restaurants.map(r => r.totals.profitMargin),
                            backgroundColor: 'rgba(255, 107, 107, 0.2)',
                            borderColor: '#FF6B6B',
                            borderWidth: 2
                        }
                    ];
                } else {
                    let data, label;
                    switch(metric) {
                        case 'sales':
                            data = restaurants.map(r => r.totals.annualSales / 1000);
                            label = 'المبيعات السنوية (ألف دينار)';
                            break;
                        case 'profit':
                            data = restaurants.map(r => r.totals.annualNetProfit / 1000);
                            label = 'صافي الربح (ألف دينار)';
                            break;
                        case 'margin':
                            data = restaurants.map(r => r.totals.profitMargin);
                            label = 'هامش الربح (%)';
                            break;
                    }
                    
                    datasets = [{
                        label: label,
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: colors.slice(0, labels.length).map(color => this.adjustColor(color, -20)),
                        borderWidth: 1
                    }];
                }
                
                if (this.charts.comparison) {
                    this.charts.comparison.destroy();
                }
                
                this.charts.comparison = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                rtl: true
                            }
                        }
                    }
                });
            }
            
            updateComparisonChart() {
                const select = document.getElementById('compare-restaurants');
                const selectedOptions = Array.from(select.selectedOptions);
                const metric = document.getElementById('compare-metric').value;
                
                if (selectedOptions.length < 2) return;
                
                const restaurants = selectedOptions.map(option => {
                    const id = parseInt(option.value);
                    return this.dataManager.getRestaurantData(id);
                }).filter(Boolean);
                
                this.drawComparisonChart(restaurants, metric);
            }
            
            adjustColor(color, amount) {
                return '#' + color.replace(/^#/, '').replace(/../g, color => 
                    ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2)
                );
            }
            
            exportComparisonExcel() {
                const select = document.getElementById('compare-restaurants');
                const selectedOptions = Array.from(select.selectedOptions);
                
                if (selectedOptions.length < 2) {
                    this.showNotification('يرجى اختيار مطاعم للمقارنة أولاً', 'error');
                    return;
                }
                
                const restaurants = selectedOptions.map(option => {
                    const id = parseInt(option.value);
                    return this.dataManager.getRestaurantData(id);
                }).filter(Boolean);
                
                const wb = XLSX.utils.book_new();
                
                const comparisonData = [
                    ['مقارنة أداء المطاعم حسب معادلات Excel - شركة نايف للأغذية'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['المطعم', 'مدير المنطقة', 'مدير التشغيل', 'المبيعات السنوية', 'تكلفة المواد', 
                     'مجمل الربح', 'مصاريف التشغيل', 'صافي الربح', 'هامش الربح', 'مستوى الأداء', 'الترتيب']
                ];
                
                restaurants.forEach((rest, index) => {
                    const performance = this.dataManager.getPerformanceLevel(rest.totals.profitMargin);
                    comparisonData.push([
                        rest.name,
                        rest.areaManager,
                        rest.operationsManager,
                        rest.totals.annualSales,
                        rest.totals.annualTotalMaterialCost,
                        rest.totals.annualGrossProfit,
                        rest.totals.annualTotalOperatingCost,
                        rest.totals.annualNetProfit,
                        rest.totals.profitMargin.toFixed(2) + '%',
                        performance.level,
                        index + 1
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(comparisonData);
                XLSX.utils.book_append_sheet(wb, ws, 'مقارنة المطاعم');
                
                XLSX.writeFile(wb, `مقارنة_المطاعم_${new Date().toISOString().slice(0, 10)}.xlsx`);
                this.showNotification('تم تصدير المقارنة إلى ملف Excel', 'success');
            }
            
            exportManagersReportExcel() {
                const managers = this.dataManager.getManagersData();
                const wb = XLSX.utils.book_new();
                
                const managerData = [
                    ['تقرير أداء المديرين - شركة نايف للأغذية'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['اسم المدير', 'نوع المدير', 'عدد المطاعم', 'إجمالي المبيعات', 'إجمالي الربح', 'هامش الربح', 'المتوسط لكل مطعم']
                ];
                
                Object.values(managers).forEach(manager => {
                    managerData.push([
                        manager.name,
                        manager.type,
                        manager.restaurantCount,
                        manager.totalSales,
                        manager.totalProfit,
                        manager.profitMargin.toFixed(2) + '%',
                        manager.averageProfit > 0 ? Math.round(manager.averageProfit * 100) / 100 : 0
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(managerData);
                XLSX.utils.book_append_sheet(wb, ws, 'تقرير المديرين');
                
                XLSX.writeFile(wb, `تقرير_المديرين_${new Date().toISOString().slice(0, 10)}.xlsx`);
                this.showNotification('تم تصدير تقرير المديرين إلى ملف Excel', 'success');
            }
            
            showExport() {
                const content = `
                    <div class="dashboard-header">
                        <h1><i class="fas fa-download"></i> تصدير البيانات والتقارير</h1>
                    </div>
                    
                    <div class="export-options">
                        <div class="export-option" onclick="dashboard.exportAllData()">
                            <i class="fas fa-file-excel"></i>
                            <h3>تصدير جميع البيانات</h3>
                            <p>تصدير جميع البيانات إلى ملف Excel واحد</p>
                            <button class="btn btn-primary">تصدير (Excel)</button>
                        </div>
                        
                        <div class="export-option" onclick="dashboard.exportRestaurantsData()">
                            <i class="fas fa-store"></i>
                            <h3>بيانات المطاعم</h3>
                            <p>تصدير بيانات جميع المطاعم</p>
                            <button class="btn btn-primary">تصدير (Excel)</button>
                        </div>
                        
                        <div class="export-option" onclick="dashboard.exportManagersReportExcel()">
                            <i class="fas fa-user-tie"></i>
                            <h3>تقرير المديرين</h3>
                            <p>تصدير تقرير أداء المديرين</p>
                            <button class="btn btn-primary">تصدير (Excel)</button>
                        </div>
                        
                        <div class="export-option" onclick="dashboard.exportMonthlyReportExcel()">
                            <i class="fas fa-calendar-alt"></i>
                            <h3>التقرير الشهري</h3>
                            <p>تصدير التقرير الشهري التفصيلي</p>
                            <button class="btn btn-primary">تصدير (Excel)</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('content-area').innerHTML = content;
            }
            
            exportAllData() {
                const wb = XLSX.utils.book_new();
                
                // شيت المطاعم
                const restaurantsData = [
                    ['تقرير شامل لجميع المطاعم - شركة نايف للأغذية'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['المطعم', 'مدير المنطقة', 'مدير التشغيل', 'المبيعات السنوية', 'تكلفة المواد', 
                     'مجمل الربح', 'مصاريف التشغيل', 'صافي الربح', 'هامش الربح', 'مستوى الأداء']
                ];
                
                this.dataManager.restaurants.forEach(restaurant => {
                    const data = this.dataManager.getRestaurantData(restaurant.id);
                    const performance = this.dataManager.getPerformanceLevel(data.totals.profitMargin);
                    
                    restaurantsData.push([
                        restaurant.name,
                        restaurant.areaManager,
                        restaurant.operationsManager,
                        data.totals.annualSales,
                        data.totals.annualTotalMaterialCost,
                        data.totals.annualGrossProfit,
                        data.totals.annualTotalOperatingCost,
                        data.totals.annualNetProfit,
                        data.totals.profitMargin.toFixed(2) + '%',
                        performance.level
                    ]);
                });
                
                const wsRestaurants = XLSX.utils.aoa_to_sheet(restaurantsData);
                XLSX.utils.book_append_sheet(wb, wsRestaurants, 'المطاعم');
                
                // شيت المديرين
                const managers = this.dataManager.getManagersData();
                const managersData = [
                    ['تقرير أداء المديرين'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['اسم المدير', 'نوع المدير', 'عدد المطاعم', 'إجمالي المبيعات', 'إجمالي الربح', 'هامش الربح']
                ];
                
                Object.values(managers).forEach(manager => {
                    managersData.push([
                        manager.name,
                        manager.type,
                        manager.restaurantCount,
                        manager.totalSales,
                        manager.totalProfit,
                        manager.profitMargin.toFixed(2) + '%'
                    ]);
                });
                
                const wsManagers = XLSX.utils.aoa_to_sheet(managersData);
                XLSX.utils.book_append_sheet(wb, wsManagers, 'المديرون');
                
                // شيت الملخص
                const totals = this.dataManager.companyTotals;
                const summaryData = [
                    ['ملخص أداء الشركة حسب معادلات Excel'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['إجمالي المبيعات', totals.totalSales],
                    ['إجمالي التكاليف', totals.totalCost],
                    ['صافي الربح', totals.totalProfit],
                    ['هامش الربح', totals.profitMargin.toFixed(2) + '%'],
                    ['عدد المطاعم', totals.totalRestaurants],
                    ['متوسط الربح للمطعم', totals.averageProfit],
                    ['أفضل مطعم', totals.bestRestaurant],
                    ['أفضل مدير', totals.bestManager]
                ];
                
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, 'ملخص_الشركة');
                
                // شيت تحليل التكاليف
                const costDetails = this.dataManager.getAllCostDetails();
                const costData = [
                    ['تحليل التكاليف التفصيلي'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['المطعم', 'مدير المنطقة', 'مدير التشغيل', 'المبيعات', 'إجمالي تكلفة المواد', 'مجمل الربح', 
                     'مجموع مصاريف التشغيل', 'الربح قبل العمومية', 'المصاريف العمومية', 'صافي الربح', 'هامش الربح']
                ];
                
                costDetails.forEach(cost => {
                    const restaurant = this.dataManager.restaurants.find(r => r.name === cost.name);
                    if (!restaurant) return;
                    
                    const totals = restaurant.totals;
                    costData.push([
                        cost.name,
                        cost.areaManager,
                        cost.operationsManager,
                        totals.annualSales,
                        cost.totalMaterialCost,
                        totals.annualGrossProfit,
                        cost.totalOperatingCost,
                        totals.annualProfitBeforeGeneral,
                        cost.generalExpenses,
                        totals.annualNetProfit,
                        totals.profitMargin.toFixed(2) + '%'
                    ]);
                });
                
                const wsCost = XLSX.utils.aoa_to_sheet(costData);
                XLSX.utils.book_append_sheet(wb, wsCost, 'تحليل_التكاليف');
                
                XLSX.writeFile(wb, `تقرير_شامل_شركة_نايف_للأغذية_${new Date().toISOString().slice(0, 10)}.xlsx`);
                this.showNotification('تم تصدير جميع البيانات بنجاح إلى ملف Excel', 'success');
            }
            
            exportRestaurantsData() {
                const wb = XLSX.utils.book_new();
                
                const restaurantData = [
                    ['بيانات جميع المطاعم حسب معادلات Excel - شركة نايف للأغذية'],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['المطعم', 'مدير المنطقة', 'مدير التشغيل', 'المبيعات السنوية', 'تكلفة المواد', 
                     'مجمل الربح', 'مصاريف التشغيل', 'صافي الربح', 'هامش الربح', 'مستوى الأداء']
                ];
                
                this.dataManager.restaurants.forEach(restaurant => {
                    const data = this.dataManager.getRestaurantData(restaurant.id);
                    const performance = this.dataManager.getPerformanceLevel(data.totals.profitMargin);
                    
                    restaurantData.push([
                        restaurant.name,
                        restaurant.areaManager,
                        restaurant.operationsManager,
                        data.totals.annualSales,
                        data.totals.annualTotalMaterialCost,
                        data.totals.annualGrossProfit,
                        data.totals.annualTotalOperatingCost,
                        data.totals.annualNetProfit,
                        data.totals.profitMargin.toFixed(2) + '%',
                        performance.level
                    ]);
                });
                
                const ws = XLSX.utils.aoa_to_sheet(restaurantData);
                XLSX.utils.book_append_sheet(wb, ws, 'بيانات_المطاعم');
                
                XLSX.writeFile(wb, `بيانات_المطاعم_${new Date().toISOString().slice(0, 10)}.xlsx`);
                this.showNotification('تم تصدير بيانات المطاعم إلى ملف Excel', 'success');
            }
            
            showRestaurantDetails(id) {
                const restaurantData = this.dataManager.getRestaurantData(id);
                if (!restaurantData) {
                    this.showNotification('لم يتم العثور على بيانات المطعم', 'error');
                    return;
                }
                
                const performance = this.dataManager.getPerformanceLevel(restaurantData.totals.profitMargin);
                
                const modal = document.getElementById('details-modal');
                const modalBody = modal.querySelector('.modal-body');
                
                modalBody.innerHTML = `
                    <div class="restaurant-details">
                        <div class="details-header">
                            <h3><i class="fas fa-store"></i> ${restaurantData.name}</h3>
                            <div class="restaurant-meta">
                                <span class="badge ${performance.class}">${performance.level}</span>
                            </div>
                        </div>
                        
                        <div class="details-summary">
                            <div class="summary-row">
                                <div class="summary-col">
                                    <p><strong>مدير المنطقة:</strong> ${restaurantData.areaManager}</p>
                                    <p><strong>مدير التشغيل:</strong> ${restaurantData.operationsManager}</p>
                                </div>
                                <div class="summary-col">
                                    <p><strong>المبيعات السنوية:</strong> ${Helpers.formatNumber(restaurantData.totals.annualSales)} د.ك</p>
                                    <p><strong>إجمالي تكلفة المواد:</strong> ${Helpers.formatNumber(restaurantData.totals.annualTotalMaterialCost)} د.ك</p>
                                    <p><strong>مجمل الربح:</strong> ${Helpers.formatNumber(restaurantData.totals.annualGrossProfit)} د.ك</p>
                                    <p><strong>مجموع مصاريف التشغيل:</strong> ${Helpers.formatNumber(restaurantData.totals.annualTotalOperatingCost)} د.ك</p>
                                    <p><strong>الربح قبل العمومية:</strong> ${Helpers.formatNumber(restaurantData.totals.annualProfitBeforeGeneral)} د.ك</p>
                                    <p><strong>المصاريف العمومية:</strong> ${Helpers.formatNumber(restaurantData.totals.annualGeneralExpenses)} د.ك</p>
                                    <p><strong>صافي الربح:</strong> 
                                        <span class="${restaurantData.totals.annualNetProfit >= 0 ? 'positive' : 'negative'}">
                                            ${Helpers.formatNumber(restaurantData.totals.annualNetProfit)} د.ك
                                        </span>
                                    </p>
                                    <p><strong>هامش الربح:</strong> ${restaurantData.totals.profitMargin.toFixed(2)}%</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-actions">
                            <button class="btn btn-secondary" onclick="dashboard.exportRestaurantReportExcel(${restaurantData.id})">
                                <i class="fas fa-download"></i> تصدير تقرير المطعم (Excel)
                            </button>
                        </div>
                    </div>
                `;
                
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                const closeBtn = modal.querySelector('.close-btn');
                closeBtn.onclick = () => this.closeModal(modal);
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        this.closeModal(modal);
                    }
                };
            }
            
            exportRestaurantReportExcel(id) {
                const restaurant = this.dataManager.getRestaurantData(id);
                if (!restaurant) return;
                
                const wb = XLSX.utils.book_new();
                
                const reportData = [
                    [`تقرير المطعم: ${restaurant.name} (حسب معادلات Excel)`],
                    ['تاريخ التصدير:', new Date().toLocaleDateString('ar-SA')],
                    [''],
                    ['معلومات المطعم'],
                    ['مدير المنطقة:', restaurant.areaManager],
                    ['مدير التشغيل:', restaurant.operationsManager],
                    [''],
                    ['البيانات السنوية'],
                    ['المبيعات السنوية:', restaurant.totals.annualSales],
                    ['إجمالي تكلفة المواد:', restaurant.totals.annualTotalMaterialCost],
                    ['مجمل الربح:', restaurant.totals.annualGrossProfit],
                    ['مجموع مصاريف التشغيل:', restaurant.totals.annualTotalOperatingCost],
                    ['الربح قبل العمومية:', restaurant.totals.annualProfitBeforeGeneral],
                    ['المصاريف العمومية:', restaurant.totals.annualGeneralExpenses],
                    ['صافي الربح:', restaurant.totals.annualNetProfit],
                    ['هامش الربح:', restaurant.totals.profitMargin.toFixed(2) + '%'],
                    [''],
                    ['المعادلات المستخدمة'],
                    ['1. إجمالي تكلفة المواد = مجموع التكاليف الفرعية (الأسطر 7-16)'],
                    ['2. مجمل الربح = المبيعات - إجمالي تكلفة المواد'],
                    ['3. مجموع مصاريف التشغيل = مجموع مصاريف التشغيل الفرعية (الأسطر 18-27)'],
                    ['4. الربح قبل العمومية = مجمل الربح - مجموع مصاريف التشغيل'],
                    ['5. صافي الربح = الربح قبل العمومية - المصاريف العمومية']
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(reportData);
                XLSX.utils.book_append_sheet(wb, ws, `تقرير_${restaurant.name}`);
                
                XLSX.writeFile(wb, `تقرير_${restaurant.name}_${new Date().toISOString().slice(0, 10)}.xlsx`);
                this.showNotification('تم تصدير تقرير المطعم إلى ملف Excel', 'success');
            }
            
            closeModal(modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            showNotification(message, type = 'info') {
                const oldNotifications = document.querySelectorAll('.notification');
                oldNotifications.forEach(n => {
                    n.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => n.remove(), 300);
                });
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                let icon = 'info-circle';
                if (type === 'success') icon = 'check-circle';
                if (type === 'error') icon = 'exclamation-circle';
                
                notification.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, 4000);
            }
        }

        // Main Application
        class NaifFoodAnalytics {
            constructor() {
                this.dataManager = new DataManager();
                this.dashboard = null;
                this.init();
            }

            init() {
                this.hideLoadingScreen();
                this.dataManager.loadFromLocalStorage();
                this.initUI();
                this.initDashboard();
                this.updateCurrentDate();
            }

            hideLoadingScreen() {
                const loadingElement = document.querySelector('.loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            }

            initUI() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                const loadExcelBtn = document.getElementById('load-excel-btn');
                const excelInput = document.getElementById('excel-input');
                const downloadTemplateBtn = document.getElementById('download-template-btn');

                if (loadExcelBtn) {
                    loadExcelBtn.addEventListener('click', () => {
                        if (excelInput) {
                            excelInput.click();
                        }
                    });
                }

                if (excelInput) {
                    excelInput.addEventListener('change', (e) => {
                        if (e.target.files && e.target.files[0]) {
                            const file = e.target.files[0];
                            this.handleExcelUpload(file);
                        }
                    });
                }

                if (downloadTemplateBtn) {
                    downloadTemplateBtn.addEventListener('click', () => {
                        this.downloadExcelTemplate();
                    });
                }

                window.addEventListener('beforeunload', () => {
                    this.dataManager.saveToLocalStorage();
                });
            }

            async handleExcelUpload(file) {
                if (!file) {
                    this.showNotification('لم يتم اختيار ملف', 'error');
                    return;
                }
                
                const validExtensions = ['.xlsx', '.xls'];
                const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
                
                if (!validExtensions.includes(fileExtension)) {
                    this.showNotification('الملف غير صالح. يرجى اختيار ملف Excel (.xlsx أو .xls)', 'error');
                    return;
                }
                
                try {
                    this.showNotification('جارٍ تحميل وتحليل ملف Excel...', 'info');
                    this.showLoading(true);
                    
                    await this.dataManager.loadExcelFile(file);
                    
                    this.showLoading(false);
                    this.showNotification(`تم تحميل ${this.dataManager.restaurants.length} مطعم بنجاح!`, 'success');
                    
                    this.initDashboard();
                    
                } catch (error) {
                    console.error('خطأ في تحميل ملف Excel:', error);
                    this.showNotification(`خطأ في تحميل الملف: ${error.message}`, 'error');
                    this.showLoading(false);
                }
            }

            downloadExcelTemplate() {
                try {
                    const templateData = [
                        ['مدير التشغيل', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                        ['مدير المنطقة', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                        ['اسم المطعم', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                        ['التواريخ', 'يناير 2025', 'فبراير 2025', 'مارس 2025', 'أبريل 2025', 
                         'مايو 2025', 'يونيو 2025', 'يوليو 2025', 'أغسطس 2025', 
                         'سبتمبر 2025', 'أكتوبر 2025', 'نوفمبر 2025', 'ديسمبر 2025', 'الإجمالي'],
                        ['المبيعات', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['اجمالي تكلفة المواد المباعة', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['تكلفة - المواد الغذائية - المخازن', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['تكلفة - اللحوم والمقبلات', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['تكلفة - المرطبات', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['تكلفة - التعبئة والتغليف', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['تكلفة - الخبز', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['تكلفة - البهارات والتوابل', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['تكلفة - الفحم', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['تكلفة - الخضار', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['تكلفة - الغاز', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['فرق الجرد بين بضاعة أول المدة و آخر المدة', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مجمل الربح قبل تنزيل مصاريف التشغيل', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مصاريف رواتب واجور', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مصاريف أعمال أضافية', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مصاريف توالف المواد', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مصاريف صيانة', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مصاريف نظافة', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مصاريف لوازم العمال', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مصاريف لوازم المطاعم', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مصاريف قرطاسية ومطبوعات', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مصاريف وجبات عاملين', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['باقي مصاريف التشغيل', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['مجموع مصاريف التشغيل', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['الربح قبل تنزيل المصاريف العمومية', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['المصاريف العمومية', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        ['صافى الربح', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                    ];
                    
                    const ws = XLSX.utils.aoa_to_sheet(templateData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'بيانات المطاعم');
                    
                    const wscols = [];
                    for (let i = 0; i < 14; i++) {
                        wscols.push({ wch: 25 });
                    }
                    ws['!cols'] = wscols;
                    
                    ws['A1'].s = { font: { bold: true, color: { rgb: "000000" } } };
                    
                    XLSX.writeFile(wb, 'نموذج_بيانات_مطاعم_نايف_للأغذية.xlsx');
                    
                    this.showNotification('تم تحميل نموذج Excel بنجاح', 'success');
                    
                } catch (error) {
                    console.error('خطأ في إنشاء النموذج:', error);
                    this.showNotification('خطأ في إنشاء النموذج: ' + error.message, 'error');
                }
            }

            initDashboard() {
                this.dashboard = new Dashboard(this.dataManager);
                window.dashboard = this.dashboard;
                
                if (this.dataManager.restaurants.length === 0) {
                    this.showNoDataMessage();
                }
            }

            showNoDataMessage() {
                const contentArea = document.getElementById('content-area');
                if (!contentArea) return;
                
                contentArea.innerHTML = `
                    <div style="
                        text-align: center; 
                        padding: 60px 20px;
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
                        margin: 20px;
                        border: 2px dashed #e0e0e0;
                    ">
                        <div class="logo-image" style="
                            width: 100px;
                            height: 100px;
                            margin: 0 auto 20px auto;
                        "></div>
                        <h2 style="
                            color: #2C3E50; 
                            margin-bottom: 15px;
                            font-size: 1.8rem;
                        ">مرحباً بك في نظام تحليل شركة نايف للأغذية</h2>
                        <p style="
                            color: #666; 
                            margin-bottom: 20px; 
                            font-size: 1.1rem;
                            line-height: 1.6;
                            max-width: 600px;
                            margin-left: auto;
                            margin-right: auto;
                        ">
                            لم يتم تحميل أي بيانات بعد. يرجى تحميل ملف Excel الخاص بك لبدء استخدام النظام.
                        </p>
                        <p style="
                            color: #888; 
                            margin-bottom: 30px; 
                            font-size: 0.95rem;
                        ">
                            يمكنك تحميل نموذج Excel فارغ لمعرفة هيكل الملف المطلوب
                        </p>
                        <div style="
                            display: flex;
                            gap: 15px;
                            justify-content: center;
                            flex-wrap: wrap;
                        ">
                            <button class="btn btn-primary" onclick="document.getElementById('excel-input').click()" 
                                    style="font-size: 1.1rem; padding: 12px 24px;">
                                <i class="fas fa-upload"></i> تحميل ملف Excel
                            </button>
                            <button class="btn btn-secondary" onclick="window.app.downloadExcelTemplate()" 
                                    style="font-size: 1.1rem; padding: 12px 24px;">
                                <i class="fas fa-download"></i> تحميل النموذج
                            </button>
                        </div>
                    </div>
                `;
            }

            showLoading(show) {
                const contentArea = document.getElementById('content-area');
                if (!contentArea) return;
                
                if (show) {
                    contentArea.innerHTML = `
                        <div class="loading" style="
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            height: 60vh;
                            text-align: center;
                        ">
                            <i class="fas fa-spinner fa-spin" style="
                                font-size: 3rem;
                                color: #4A90E2;
                                margin-bottom: 20px;
                            "></i>
                            <p style="
                                font-size: 1.2rem;
                                color: #666;
                            ">جار تحميل البيانات وتحليل الملف...</p>
                            <p style="
                                font-size: 0.9rem;
                                color: #888;
                                margin-top: 10px;
                            ">قد تستغرق هذه العملية بضع لحظات</p>
                        </div>
                    `;
                }
            }

            showNotification(message, type = 'info') {
                const oldNotifications = document.querySelectorAll('.notification');
                oldNotifications.forEach(n => {
                    n.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => n.remove(), 300);
                });
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                let icon = 'info-circle';
                if (type === 'success') icon = 'check-circle';
                if (type === 'error') icon = 'exclamation-circle';
                
                notification.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, 4000);
            }

            updateCurrentDate() {
                const now = new Date();
                const dateElement = document.getElementById('current-date');
                if (dateElement) {
                    const options = { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric'
                    };
                    dateElement.textContent = now.toLocaleDateString('ar-SA', options).replace(/٢٠٢٥/g, '2025');
                    
                    setInterval(() => {
                        dateElement.textContent = new Date().toLocaleDateString('ar-SA', options).replace(/٢٠٢٥/g, '2025');
                    }, 60000);
                }
            }

            getData() {
                return {
                    restaurants: this.dataManager.restaurants,
                    totals: this.dataManager.companyTotals,
                    monthlyData: this.dataManager.monthlyData
                };
            }
        }

        // Start Application
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if (typeof XLSX === 'undefined') {
                    throw new Error('مكتبة Excel غير محملة. تحقق من اتصال الإنترنت.');
                }
                
                if (typeof Chart === 'undefined') {
                    throw new Error('مكتبة Charts غير محملة. تحقق من اتصال الإنترنت.');
                }
                
                window.app = new NaifFoodAnalytics();
                
            } catch (error) {
                console.error('خطأ فادح في تهيئة التطبيق:', error);
                
                const contentArea = document.getElementById('content-area');
                if (contentArea) {
                    contentArea.innerHTML = `
                        <div style="
                            text-align: center; 
                            padding: 50px 20px; 
                            color: #dc3545;
                            background: white;
                            border-radius: 10px;
                            margin: 20px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                        ">
                            <i class="fas fa-exclamation-triangle" style="
                                font-size: 4rem; 
                                margin-bottom: 20px;
                            "></i>
                            <h2 style="margin-bottom: 15px;">خطأ في تحميل النظام</h2>
                            <p style="
                                margin-bottom: 20px; 
                                color: #666;
                                font-size: 1.1rem;
                            ">${error.message}</p>
                            <p style="
                                margin-bottom: 25px; 
                                color: #888;
                                font-size: 0.95rem;
                            ">يرجى التحقق من اتصال الإنترنت وإعادة تحميل الصفحة</p>
                            <button onclick="location.reload()" class="btn btn-primary" style="
                                padding: 12px 24px;
                                font-size: 1.1rem;
                            ">
                                <i class="fas fa-redo"></i> إعادة تحميل الصفحة
                            </button>
                        </div>
                    `;
                }
                
                const loadingElement = document.querySelector('.loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            }
        });

        if (typeof window !== 'undefined') {
            window.NaifFoodAnalytics = NaifFoodAnalytics;
        }
    </script>
</body>
</html>
